<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0f1419;
            color: #e7e9ea;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #2f3336;
        }
        h1 {
            font-size: 2rem;
            margin-bottom: 8px;
        }
        .subtitle {
            color: #71767b;
            font-size: 0.9rem;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .grid-wide {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: #16181c;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #2f3336;
        }
        .card-full {
            grid-column: 1 / -1;
        }
        .card h2 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #71767b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        .stat {
            text-align: center;
        }
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #fff;
        }
        .stat-value.positive { color: #00ba7c; }
        .stat-value.negative { color: #f4212e; }
        .stat-label {
            font-size: 0.8rem;
            color: #71767b;
            margin-top: 4px;
        }
        .section {
            margin-bottom: 30px;
        }
        .section h2 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #2f3336;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #2f3336;
        }
        th {
            color: #71767b;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.75rem;
        }
        tr:hover {
            background: #1d1f23;
        }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge-win { background: #00ba7c22; color: #00ba7c; }
        .badge-loss { background: #f4212e22; color: #f4212e; }
        .badge-pending { background: #ffd40022; color: #ffd400; }
        .badge-yes { background: #1d9bf022; color: #1d9bf0; }
        .badge-no { background: #7856ff22; color: #7856ff; }
        .chart-container {
            position: relative;
            height: 280px;
            margin-top: 15px;
        }
        .chart-container-tall {
            position: relative;
            height: 350px;
            margin-top: 15px;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background: #16181c;
            border: 1px solid #2f3336;
            border-radius: 8px;
            cursor: pointer;
            color: #71767b;
            transition: all 0.2s;
        }
        .tab:hover {
            background: #1d1f23;
        }
        .tab.active {
            background: #1d9bf0;
            border-color: #1d9bf0;
            color: #fff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #71767b;
        }
        .ev-bucket-table td:first-child {
            font-weight: 600;
        }
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            font-size: 0.8rem;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        @media (max-width: 768px) {
            .stat-grid {
                grid-template-columns: 1fr;
            }
            .grid, .grid-wide {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Trading Dashboard</h1>
            <p class="subtitle">Props & Weather Auto-Trading Performance</p>
            <p class="subtitle" id="lastUpdated"></p>
        </header>

        <div class="tabs">
            <div class="tab active" data-tab="weather">Weather</div>
            <div class="tab" data-tab="props">Props</div>
            <div class="tab" data-tab="sports">Sports</div>
            <div class="tab" data-tab="models">Forecast Models</div>
        </div>

        <!-- Weather Tab -->
        <div id="weather-tab" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <h2>Performance</h2>
                    <div class="stat-grid">
                        <div class="stat">
                            <div class="stat-value" id="weather-record">-</div>
                            <div class="stat-label">Record</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="weather-roi">-</div>
                            <div class="stat-label">ROI</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="weather-trades">-</div>
                            <div class="stat-label">Total Trades</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="weather-avg-ev">-</div>
                            <div class="stat-label">Avg EV</div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h2>P&L</h2>
                    <div class="stat-grid">
                        <div class="stat">
                            <div class="stat-value" id="weather-cost">-</div>
                            <div class="stat-label">Total Cost</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="weather-payout">-</div>
                            <div class="stat-label">Total Payout</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="weather-profit">-</div>
                            <div class="stat-label">Net Profit</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="weather-pending">-</div>
                            <div class="stat-label">Pending</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid-wide">
                <div class="card">
                    <h2>Cumulative P&L Over Time</h2>
                    <div class="chart-container-tall">
                        <canvas id="weather-pnl-chart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2>Expected EV vs Realized ROI</h2>
                    <div class="chart-container-tall">
                        <canvas id="weather-ev-vs-realized-chart"></canvas>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #1d9bf0;"></div>
                            <span>Expected EV</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #00ba7c;"></div>
                            <span>Realized ROI</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid-wide">
                <div class="card">
                    <h2>Win Rate by City</h2>
                    <div class="chart-container">
                        <canvas id="weather-city-chart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2>Trade Distribution by EV</h2>
                    <div class="chart-container">
                        <canvas id="weather-ev-dist-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Results by EV Bucket</h2>
                <div class="card">
                    <table class="ev-bucket-table">
                        <thead>
                            <tr>
                                <th>EV Bucket</th>
                                <th>Trades</th>
                                <th>W-L-P</th>
                                <th>Win Rate</th>
                                <th>Avg Price</th>
                                <th>Expected EV</th>
                                <th>Realized ROI</th>
                            </tr>
                        </thead>
                        <tbody id="weather-ev-buckets"></tbody>
                    </table>
                </div>
            </div>

            <div class="section">
                <h2>Results by City</h2>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>City</th>
                                <th>Trades</th>
                                <th>Wins</th>
                                <th>Losses</th>
                                <th>Win Rate</th>
                                <th>Avg EV</th>
                            </tr>
                        </thead>
                        <tbody id="weather-cities"></tbody>
                    </table>
                </div>
            </div>

            <div class="section">
                <h2>Recent Trades</h2>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>City</th>
                                <th>Event</th>
                                <th>Side</th>
                                <th>Price</th>
                                <th>EV</th>
                                <th>Result</th>
                            </tr>
                        </thead>
                        <tbody id="weather-trades-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Props Tab -->
        <div id="props-tab" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>Performance</h2>
                    <div class="stat-grid">
                        <div class="stat">
                            <div class="stat-value" id="props-record">-</div>
                            <div class="stat-label">Record</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="props-roi">-</div>
                            <div class="stat-label">ROI</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="props-trades">-</div>
                            <div class="stat-label">Total Trades</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="props-avg-edge">-</div>
                            <div class="stat-label">Avg Edge</div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h2>P&L</h2>
                    <div class="stat-grid">
                        <div class="stat">
                            <div class="stat-value" id="props-cost">-</div>
                            <div class="stat-label">Total Cost</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="props-payout">-</div>
                            <div class="stat-label">Total Payout</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="props-profit">-</div>
                            <div class="stat-label">Net Profit</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="props-pending">-</div>
                            <div class="stat-label">Pending</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid-wide">
                <div class="card">
                    <h2>Cumulative P&L Over Time</h2>
                    <div class="chart-container-tall">
                        <canvas id="props-pnl-chart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2>Expected EV vs Realized ROI</h2>
                    <div class="chart-container-tall">
                        <canvas id="props-ev-vs-realized-chart"></canvas>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #1d9bf0;"></div>
                            <span>Expected EV</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #00ba7c;"></div>
                            <span>Realized ROI</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid-wide">
                <div class="card">
                    <h2>By Stat Type</h2>
                    <div class="chart-container">
                        <canvas id="props-stat-chart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2>Edge Distribution</h2>
                    <div class="chart-container">
                        <canvas id="props-edge-dist-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Results by EV Bucket</h2>
                <div class="card">
                    <table class="ev-bucket-table">
                        <thead>
                            <tr>
                                <th>EV Bucket</th>
                                <th>Trades</th>
                                <th>W-L-P</th>
                                <th>Win Rate</th>
                                <th>Avg Price</th>
                                <th>Expected EV</th>
                                <th>Realized ROI</th>
                            </tr>
                        </thead>
                        <tbody id="props-ev-buckets"></tbody>
                    </table>
                </div>
            </div>

            <div class="section">
                <h2>Recent Trades</h2>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Player</th>
                                <th>Stat</th>
                                <th>Line</th>
                                <th>Side</th>
                                <th>Price</th>
                                <th>Edge</th>
                                <th>Result</th>
                            </tr>
                        </thead>
                        <tbody id="props-trades-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sports Tab -->
        <div id="sports-tab" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>Performance</h2>
                    <div class="stat-grid">
                        <div class="stat">
                            <div class="stat-value" id="sports-record">-</div>
                            <div class="stat-label">Record</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="sports-roi">-</div>
                            <div class="stat-label">ROI</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="sports-trades">-</div>
                            <div class="stat-label">Total Trades</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="sports-avg-edge">-</div>
                            <div class="stat-label">Avg Edge</div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h2>P&L</h2>
                    <div class="stat-grid">
                        <div class="stat">
                            <div class="stat-value" id="sports-cost">-</div>
                            <div class="stat-label">Total Cost</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="sports-payout">-</div>
                            <div class="stat-label">Total Payout</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="sports-profit">-</div>
                            <div class="stat-label">Net Profit</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="sports-pending">-</div>
                            <div class="stat-label">Pending</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid-wide">
                <div class="card">
                    <h2>Cumulative P&L Over Time</h2>
                    <div class="chart-container-tall">
                        <canvas id="sports-pnl-chart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2>Expected EV vs Realized ROI</h2>
                    <div class="chart-container-tall">
                        <canvas id="sports-ev-vs-realized-chart"></canvas>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #1d9bf0;"></div>
                            <span>Expected EV</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #00ba7c;"></div>
                            <span>Realized ROI</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid-wide">
                <div class="card">
                    <h2>By Line Type</h2>
                    <div class="chart-container">
                        <canvas id="sports-line-type-chart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2>Edge Distribution</h2>
                    <div class="chart-container">
                        <canvas id="sports-edge-dist-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Results by EV Bucket</h2>
                <div class="card">
                    <table class="ev-bucket-table">
                        <thead>
                            <tr>
                                <th>EV Bucket</th>
                                <th>Trades</th>
                                <th>W-L-P</th>
                                <th>Win Rate</th>
                                <th>Avg Price</th>
                                <th>Expected EV</th>
                                <th>Realized ROI</th>
                            </tr>
                        </thead>
                        <tbody id="sports-ev-buckets"></tbody>
                    </table>
                </div>
            </div>

            <div class="section">
                <h2>Recent Trades</h2>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Event</th>
                                <th>Type</th>
                                <th>Line</th>
                                <th>Side</th>
                                <th>Price</th>
                                <th>Edge</th>
                                <th>Result</th>
                            </tr>
                        </thead>
                        <tbody id="sports-trades-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Models Tab -->
        <div id="models-tab" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>Best Performing Model</h2>
                    <div class="stat-grid">
                        <div class="stat">
                            <div class="stat-value" id="models-best-name">-</div>
                            <div class="stat-label">Model Name</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="models-best-mae">-</div>
                            <div class="stat-label">MAE (°F)</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="models-best-bias">-</div>
                            <div class="stat-label">Bias (°F)</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="models-days-tracked">-</div>
                            <div class="stat-label">Days Tracked</div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h2>Model Comparison</h2>
                    <p style="color: #71767b; font-size: 0.9rem; margin-bottom: 15px;">
                        Lower MAE = More Accurate | Positive Bias = Forecasts Too Hot
                    </p>
                    <div class="chart-container">
                        <canvas id="models-mae-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>All Models Accuracy</h2>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Model</th>
                                <th>Days</th>
                                <th>Forecasts</th>
                                <th>MAE (°F)</th>
                                <th>Bias (°F)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="models-table"></tbody>
                    </table>
                </div>
            </div>

            <div class="section">
                <h2>Recent Forecasts vs Observed</h2>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>City</th>
                                <th>Model</th>
                                <th>Forecast</th>
                                <th>Observed</th>
                                <th>Error</th>
                            </tr>
                        </thead>
                        <tbody id="models-recent-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
            });
        });

        // Format helpers
        const fmt = {
            pct: (v) => v != null ? `${(v * 100).toFixed(1)}%` : '-',
            pctNum: (v) => v != null ? `${v.toFixed(1)}%` : '-',
            cents: (v) => v != null ? `$${(v / 100).toFixed(2)}` : '-',
            date: (v) => v ? new Date(v).toLocaleDateString() : '-',
        };

        // Chart.js defaults for dark theme
        Chart.defaults.color = '#71767b';
        Chart.defaults.borderColor = '#2f3336';

        // Load and render data
        async function loadData() {
            try {
                const [summaryRes, weatherRes, propsRes, sportsRes, modelsRes] = await Promise.all([
                    fetch('data/summary.json'),
                    fetch('data/weather.json'),
                    fetch('data/props.json'),
                    fetch('data/sports.json'),
                    fetch('data/model_accuracy.json'),
                ]);

                const summary = await summaryRes.json();
                const weather = await weatherRes.json();
                const props = await propsRes.json();
                const sports = await sportsRes.json();
                const models = await modelsRes.json();

                renderWeather(weather);
                renderProps(props);
                renderSports(sports);
                renderModels(models);

                document.getElementById('lastUpdated').textContent =
                    `Last updated: ${new Date(summary.generated_at).toLocaleString()}`;
            } catch (err) {
                console.error('Failed to load data:', err);
            }
        }

        function renderWeather(data) {
            // Summary stats
            document.getElementById('weather-record').textContent =
                `${data.wins}W - ${data.losses}L`;
            document.getElementById('weather-roi').textContent = fmt.pctNum(data.roi);
            document.getElementById('weather-roi').classList.add(data.roi >= 0 ? 'positive' : 'negative');
            document.getElementById('weather-trades').textContent = data.total_trades;
            document.getElementById('weather-avg-ev').textContent = fmt.pct(data.avg_ev);
            document.getElementById('weather-cost').textContent = fmt.cents(data.total_cost_cents);
            document.getElementById('weather-payout').textContent = fmt.cents(data.total_payout_cents);
            const profit = data.total_payout_cents - data.total_cost_cents;
            document.getElementById('weather-profit').textContent = fmt.cents(profit);
            document.getElementById('weather-profit').classList.add(profit >= 0 ? 'positive' : 'negative');
            document.getElementById('weather-pending').textContent = data.pending;

            // Cumulative P&L Chart
            const trades = (data.trades || []).slice().reverse(); // oldest first
            let cumPnl = 0;
            const pnlData = trades.filter(t => t.settled).map((t, i) => {
                const cost = t.fill_price_cents || t.limit_price_cents || 0;
                const payout = t.won ? 100 : 0;
                cumPnl += (payout - cost);
                return { x: i + 1, y: cumPnl / 100 };
            });

            if (pnlData.length > 0) {
                new Chart(document.getElementById('weather-pnl-chart'), {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Cumulative P&L ($)',
                            data: pnlData,
                            borderColor: '#1d9bf0',
                            backgroundColor: '#1d9bf022',
                            fill: true,
                            tension: 0.3,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { type: 'linear', title: { display: true, text: 'Trade #' } },
                            y: { title: { display: true, text: 'P&L ($)' } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // EV vs Realized ROI Chart
            const evBuckets = ['0-5%', '5-10%', '10-15%', '15-20%', '20%+'];
            const evMidpoints = [2.5, 7.5, 12.5, 17.5, 25]; // midpoint EV for each bucket
            const expectedEV = [];
            const realizedROI = [];

            evBuckets.forEach((bucket, i) => {
                const b = data.by_ev_bucket[bucket];
                if (b && b.count > 0) {
                    expectedEV.push(evMidpoints[i]);
                    realizedROI.push(b.roi || 0);
                } else {
                    expectedEV.push(evMidpoints[i]);
                    realizedROI.push(null);
                }
            });

            new Chart(document.getElementById('weather-ev-vs-realized-chart'), {
                type: 'bar',
                data: {
                    labels: evBuckets,
                    datasets: [
                        {
                            label: 'Expected EV (%)',
                            data: expectedEV,
                            backgroundColor: '#1d9bf0',
                            borderRadius: 4,
                        },
                        {
                            label: 'Realized ROI (%)',
                            data: realizedROI,
                            backgroundColor: '#00ba7c',
                            borderRadius: 4,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { title: { display: true, text: 'Percentage (%)' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // City Win Rate Chart
            const cities = Object.entries(data.by_city || {}).sort((a, b) => b[1].count - a[1].count);
            if (cities.length > 0) {
                const cityLabels = cities.map(c => c[0]);
                const cityWinRates = cities.map(c => {
                    const total = (c[1].wins || 0) + (c[1].losses || 0);
                    return total > 0 ? ((c[1].wins || 0) / total * 100) : 0;
                });

                new Chart(document.getElementById('weather-city-chart'), {
                    type: 'bar',
                    data: {
                        labels: cityLabels,
                        datasets: [{
                            label: 'Win Rate (%)',
                            data: cityWinRates,
                            backgroundColor: '#7856ff',
                            borderRadius: 4,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        scales: {
                            x: { max: 100, title: { display: true, text: 'Win Rate (%)' } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // EV Distribution Chart
            const evCounts = evBuckets.map(bucket => {
                const b = data.by_ev_bucket[bucket];
                return b ? b.count : 0;
            });

            new Chart(document.getElementById('weather-ev-dist-chart'), {
                type: 'doughnut',
                data: {
                    labels: evBuckets,
                    datasets: [{
                        data: evCounts,
                        backgroundColor: ['#71767b', '#ffd400', '#00ba7c', '#1d9bf0', '#7856ff'],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#e7e9ea' }
                        }
                    }
                }
            });

            // EV Buckets Table (enhanced)
            const evHtml = evBuckets.map((bucket, i) => {
                const b = data.by_ev_bucket[bucket] || { count: 0, wins: 0, losses: 0, pending: 0, total_cost_cents: 0, total_payout_cents: 0, roi: 0 };
                const roiClass = b.roi >= 0 ? 'positive' : 'negative';
                const totalSettled = (b.wins || 0) + (b.losses || 0);
                const winRate = totalSettled > 0 ? ((b.wins || 0) / totalSettled * 100).toFixed(0) : '-';
                const avgPrice = b.count > 0 ? (b.total_cost_cents / b.count).toFixed(0) : '-';
                return `<tr>
                    <td>${bucket}</td>
                    <td>${b.count}</td>
                    <td>${b.wins}-${b.losses}-${b.pending}</td>
                    <td>${winRate}%</td>
                    <td>${avgPrice}¢</td>
                    <td>${evMidpoints[i]}%</td>
                    <td class="${roiClass}">${fmt.pctNum(b.roi)}</td>
                </tr>`;
            }).join('');
            document.getElementById('weather-ev-buckets').innerHTML = evHtml;

            // Cities Table (enhanced)
            const cityHtml = cities.map(([city, stats]) => {
                const totalSettled = (stats.wins || 0) + (stats.losses || 0);
                const winRate = totalSettled > 0 ? ((stats.wins || 0) / totalSettled * 100).toFixed(0) : '-';
                return `<tr>
                    <td>${city}</td>
                    <td>${stats.count}</td>
                    <td>${stats.wins || 0}</td>
                    <td>${stats.losses || 0}</td>
                    <td>${winRate}%</td>
                    <td>${fmt.pct(stats.avg_ev)}</td>
                </tr>`;
            }).join('');
            document.getElementById('weather-cities').innerHTML = cityHtml || '<tr><td colspan="6">No data</td></tr>';

            // Trades table
            const tradesHtml = (data.trades || []).slice(0, 20).map(t => {
                let resultBadge = '<span class="badge badge-pending">Pending</span>';
                if (t.settled) {
                    resultBadge = t.won
                        ? '<span class="badge badge-win">Win</span>'
                        : '<span class="badge badge-loss">Loss</span>';
                }
                const sideBadge = t.side === 'YES'
                    ? '<span class="badge badge-yes">YES</span>'
                    : '<span class="badge badge-no">NO</span>';
                return `<tr>
                    <td>${t.trade_date}</td>
                    <td>${t.city_key}</td>
                    <td>${t.event_display}</td>
                    <td>${sideBadge}</td>
                    <td>${t.fill_price_cents || t.limit_price_cents}¢</td>
                    <td>${fmt.pct(t.ev)}</td>
                    <td>${resultBadge}</td>
                </tr>`;
            }).join('');
            document.getElementById('weather-trades-table').innerHTML = tradesHtml || '<tr><td colspan="7">No trades</td></tr>';
        }

        function renderProps(data) {
            // Summary stats
            document.getElementById('props-record').textContent =
                `${data.wins || 0}W - ${data.losses || 0}L`;
            document.getElementById('props-roi').textContent = fmt.pctNum(data.roi || 0);
            document.getElementById('props-roi').classList.add((data.roi || 0) >= 0 ? 'positive' : 'negative');
            document.getElementById('props-trades').textContent = data.total_trades;
            document.getElementById('props-avg-edge').textContent = fmt.pct(data.avg_edge);

            // P&L stats
            document.getElementById('props-cost').textContent = fmt.cents(data.total_cost_cents);
            document.getElementById('props-payout').textContent = fmt.cents(data.total_payout_cents || 0);
            const profit = (data.total_payout_cents || 0) - (data.total_cost_cents || 0);
            document.getElementById('props-profit').textContent = fmt.cents(profit);
            document.getElementById('props-profit').classList.add(profit >= 0 ? 'positive' : 'negative');
            document.getElementById('props-pending').textContent = data.pending || 0;

            // Cumulative P&L Chart (for settled trades only)
            const trades = (data.trades || []).slice().reverse(); // oldest first
            let cumPnl = 0;
            const pnlData = trades.filter(t => t.settled).map((t, i) => {
                const cost = t.fill_price_cents || t.limit_price_cents || 0;
                const payout = t.won ? 100 : 0;
                cumPnl += (payout - cost);
                return { x: i + 1, y: cumPnl / 100 };
            });

            if (pnlData.length > 0) {
                new Chart(document.getElementById('props-pnl-chart'), {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Cumulative P&L ($)',
                            data: pnlData,
                            borderColor: '#1d9bf0',
                            backgroundColor: '#1d9bf022',
                            fill: true,
                            tension: 0.3,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { type: 'linear', title: { display: true, text: 'Trade #' } },
                            y: { title: { display: true, text: 'P&L ($)' } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // EV vs Realized ROI Chart
            const evBuckets = ['0-5%', '5-10%', '10-15%', '15-20%', '20%+'];
            const evMidpoints = [2.5, 7.5, 12.5, 17.5, 25];
            const expectedEV = [];
            const realizedROI = [];

            evBuckets.forEach((bucket, i) => {
                const b = (data.by_ev_bucket || {})[bucket];
                if (b && b.count > 0) {
                    expectedEV.push(evMidpoints[i]);
                    realizedROI.push(b.roi || 0);
                } else {
                    expectedEV.push(evMidpoints[i]);
                    realizedROI.push(null);
                }
            });

            new Chart(document.getElementById('props-ev-vs-realized-chart'), {
                type: 'bar',
                data: {
                    labels: evBuckets,
                    datasets: [
                        {
                            label: 'Expected EV (%)',
                            data: expectedEV,
                            backgroundColor: '#1d9bf0',
                            borderRadius: 4,
                        },
                        {
                            label: 'Realized ROI (%)',
                            data: realizedROI,
                            backgroundColor: '#00ba7c',
                            borderRadius: 4,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { title: { display: true, text: 'Percentage (%)' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // Edge Distribution Histogram
            const edges = trades.map(t => (t.edge || 0) * 100);
            const edgeCounts = [0, 0, 0, 0, 0];
            edges.forEach(e => {
                if (e < 5) edgeCounts[0]++;
                else if (e < 10) edgeCounts[1]++;
                else if (e < 15) edgeCounts[2]++;
                else if (e < 20) edgeCounts[3]++;
                else edgeCounts[4]++;
            });

            new Chart(document.getElementById('props-edge-dist-chart'), {
                type: 'bar',
                data: {
                    labels: evBuckets,
                    datasets: [{
                        label: 'Trades',
                        data: edgeCounts,
                        backgroundColor: '#1d9bf0',
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { title: { display: true, text: 'Number of Trades' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // EV Buckets Table
            const evHtml = evBuckets.map((bucket, i) => {
                const b = (data.by_ev_bucket || {})[bucket] || { count: 0, wins: 0, losses: 0, pending: 0, total_cost_cents: 0, total_payout_cents: 0, roi: 0 };
                const roiClass = b.roi >= 0 ? 'positive' : 'negative';
                const totalSettled = (b.wins || 0) + (b.losses || 0);
                const winRate = totalSettled > 0 ? ((b.wins || 0) / totalSettled * 100).toFixed(0) : '-';
                const avgPrice = b.count > 0 ? (b.total_cost_cents / b.count).toFixed(0) : '-';
                return `<tr>
                    <td>${bucket}</td>
                    <td>${b.count}</td>
                    <td>${b.wins || 0}-${b.losses || 0}-${b.pending || 0}</td>
                    <td>${winRate}%</td>
                    <td>${avgPrice}¢</td>
                    <td>${evMidpoints[i]}%</td>
                    <td class="${roiClass}">${fmt.pctNum(b.roi)}</td>
                </tr>`;
            }).join('');
            document.getElementById('props-ev-buckets').innerHTML = evHtml;

            // Trades table with result
            const tradesHtml = (data.trades || []).slice(0, 20).map(t => {
                let resultBadge = '<span class="badge badge-pending">Pending</span>';
                if (t.settled) {
                    resultBadge = t.won
                        ? '<span class="badge badge-win">Win</span>'
                        : '<span class="badge badge-loss">Loss</span>';
                }
                const sideBadge = t.side === 'OVER' || t.side === 'over'
                    ? '<span class="badge badge-yes">OVER</span>'
                    : '<span class="badge badge-no">UNDER</span>';
                return `<tr>
                    <td>${t.trade_date}</td>
                    <td>${t.player_name}</td>
                    <td>${t.stat_type}</td>
                    <td>${t.line}</td>
                    <td>${sideBadge}</td>
                    <td>${t.fill_price_cents || t.limit_price_cents}¢</td>
                    <td>${fmt.pct(t.edge)}</td>
                    <td>${resultBadge}</td>
                </tr>`;
            }).join('');
            document.getElementById('props-trades-table').innerHTML = tradesHtml || '<tr><td colspan="8">No trades</td></tr>';

            // Stat type chart
            const statTypes = Object.keys(data.by_stat_type || {});
            if (statTypes.length > 0) {
                new Chart(document.getElementById('props-stat-chart'), {
                    type: 'doughnut',
                    data: {
                        labels: statTypes,
                        datasets: [{
                            data: statTypes.map(s => data.by_stat_type[s].count),
                            backgroundColor: ['#1d9bf0', '#00ba7c', '#ffd400', '#7856ff', '#f4212e'],
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { color: '#e7e9ea' }
                            }
                        }
                    }
                });
            }
        }

        function renderSports(data) {
            // Performance stats
            document.getElementById('sports-record').textContent = `${data.wins || 0}W-${data.losses || 0}L`;
            document.getElementById('sports-roi').textContent = fmt.pctNum(data.roi);
            document.getElementById('sports-trades').textContent = data.total_trades || 0;
            document.getElementById('sports-avg-edge').textContent = fmt.pct(data.avg_edge);

            // P&L stats
            const totalCost = (data.total_cost_cents || 0) / 100;
            const totalPayout = (data.total_payout_cents || 0) / 100;
            const profit = totalPayout - totalCost;
            document.getElementById('sports-cost').textContent = `$${totalCost.toFixed(2)}`;
            document.getElementById('sports-payout').textContent = `$${totalPayout.toFixed(2)}`;
            document.getElementById('sports-profit').textContent = `${profit >= 0 ? '+' : ''}$${profit.toFixed(2)}`;
            document.getElementById('sports-profit').className = profit >= 0 ? 'stat-value positive' : 'stat-value negative';
            document.getElementById('sports-pending').textContent = data.pending || 0;

            // P&L Chart
            const trades = data.trades || [];
            if (trades.length > 0) {
                const sortedTrades = [...trades].sort((a, b) => a.trade_date.localeCompare(b.trade_date));
                let cumPnl = 0;
                const pnlData = sortedTrades.map(t => {
                    const cost = (t.fill_price_cents || t.limit_price_cents || 0);
                    const payout = t.settled ? (t.payout_cents || 0) : 0;
                    cumPnl += (payout - cost) / 100;
                    return { date: t.trade_date, pnl: cumPnl };
                });

                new Chart(document.getElementById('sports-pnl-chart'), {
                    type: 'line',
                    data: {
                        labels: pnlData.map(d => d.date),
                        datasets: [{
                            label: 'Cumulative P&L ($)',
                            data: pnlData.map(d => d.pnl),
                            borderColor: pnlData[pnlData.length-1].pnl >= 0 ? '#00ba7c' : '#f4212e',
                            backgroundColor: 'transparent',
                            tension: 0.3,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { title: { display: true, text: 'P&L ($)' } } },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // EV vs Realized Chart
            const evBuckets = ['0-5%', '5-10%', '10-15%', '15-20%', '20%+'];
            const evMidpoints = [2.5, 7.5, 12.5, 17.5, 25];
            const evExpected = evMidpoints.map(m => m);
            const evRealized = evBuckets.map(bucket => {
                const b = (data.by_ev_bucket || {})[bucket];
                return b ? b.roi : 0;
            });

            new Chart(document.getElementById('sports-ev-vs-realized-chart'), {
                type: 'bar',
                data: {
                    labels: evBuckets,
                    datasets: [
                        { label: 'Expected EV', data: evExpected, backgroundColor: '#1d9bf0', borderRadius: 4 },
                        { label: 'Realized ROI', data: evRealized, backgroundColor: '#00ba7c', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });

            // Edge distribution chart
            const edgeCounts = evBuckets.map(bucket => {
                const b = (data.by_ev_bucket || {})[bucket];
                return b ? b.count : 0;
            });

            new Chart(document.getElementById('sports-edge-dist-chart'), {
                type: 'bar',
                data: {
                    labels: evBuckets,
                    datasets: [{
                        label: 'Trades',
                        data: edgeCounts,
                        backgroundColor: '#1d9bf0',
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { title: { display: true, text: 'Number of Trades' } } },
                    plugins: { legend: { display: false } }
                }
            });

            // EV Buckets Table
            const evHtml = evBuckets.map((bucket, i) => {
                const b = (data.by_ev_bucket || {})[bucket] || { count: 0, wins: 0, losses: 0, pending: 0, total_cost_cents: 0, total_payout_cents: 0, roi: 0 };
                const roiClass = b.roi >= 0 ? 'positive' : 'negative';
                const totalSettled = (b.wins || 0) + (b.losses || 0);
                const winRate = totalSettled > 0 ? ((b.wins || 0) / totalSettled * 100).toFixed(0) : '-';
                const avgPrice = b.count > 0 ? (b.total_cost_cents / b.count).toFixed(0) : '-';
                return `<tr>
                    <td>${bucket}</td>
                    <td>${b.count}</td>
                    <td>${b.wins || 0}-${b.losses || 0}-${b.pending || 0}</td>
                    <td>${winRate}%</td>
                    <td>${avgPrice}¢</td>
                    <td>${evMidpoints[i]}%</td>
                    <td class="${roiClass}">${fmt.pctNum(b.roi)}</td>
                </tr>`;
            }).join('');
            document.getElementById('sports-ev-buckets').innerHTML = evHtml;

            // Trades table with result
            const tradesHtml = (data.trades || []).slice(0, 20).map(t => {
                let resultBadge = '<span class="badge badge-pending">Pending</span>';
                if (t.settled) {
                    resultBadge = t.won
                        ? '<span class="badge badge-win">Win</span>'
                        : '<span class="badge badge-loss">Loss</span>';
                }
                const sideBadge = t.side === 'YES' || t.side === 'yes'
                    ? '<span class="badge badge-yes">YES</span>'
                    : '<span class="badge badge-no">NO</span>';
                return `<tr>
                    <td>${t.trade_date}</td>
                    <td>${t.event_title}</td>
                    <td>${t.line_type}</td>
                    <td>${t.line_label}</td>
                    <td>${sideBadge}</td>
                    <td>${t.fill_price_cents || t.limit_price_cents}¢</td>
                    <td>${fmt.pct(t.edge)}</td>
                    <td>${resultBadge}</td>
                </tr>`;
            }).join('');
            document.getElementById('sports-trades-table').innerHTML = tradesHtml || '<tr><td colspan="8">No trades</td></tr>';

            // Line type chart
            const lineTypes = Object.keys(data.by_line_type || {});
            if (lineTypes.length > 0) {
                new Chart(document.getElementById('sports-line-type-chart'), {
                    type: 'doughnut',
                    data: {
                        labels: lineTypes,
                        datasets: [{
                            data: lineTypes.map(s => data.by_line_type[s].count),
                            backgroundColor: ['#1d9bf0', '#00ba7c', '#ffd400', '#7856ff', '#f4212e'],
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { color: '#e7e9ea' }
                            }
                        }
                    }
                });
            }
        }

        function renderModels(data) {
            const models = data.models || [];

            // Best model stats
            if (models.length > 0) {
                const best = models[0];
                document.getElementById('models-best-name').textContent = best.source.replace('open_meteo_', '').replace('_', ' ').toUpperCase();
                document.getElementById('models-best-mae').textContent = `${best.mae}°`;
                document.getElementById('models-best-bias').textContent = `${best.bias > 0 ? '+' : ''}${best.bias}°`;
                document.getElementById('models-days-tracked').textContent = best.days;
            }

            // MAE Chart
            if (models.length > 0) {
                new Chart(document.getElementById('models-mae-chart'), {
                    type: 'bar',
                    data: {
                        labels: models.map(m => m.source.replace('open_meteo_', '').replace('_', ' ').toUpperCase()),
                        datasets: [
                            {
                                label: 'MAE (°F)',
                                data: models.map(m => m.mae),
                                backgroundColor: '#1d9bf0',
                                borderRadius: 4
                            },
                            {
                                label: 'Bias (°F)',
                                data: models.map(m => m.bias),
                                backgroundColor: models.map(m => m.bias >= 0 ? '#ffd400' : '#00ba7c'),
                                borderRadius: 4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                title: { display: true, text: 'Error (°F)' },
                                beginAtZero: true
                            }
                        },
                        plugins: { legend: { display: true } }
                    }
                });
            }

            // Models table
            const modelsHtml = models.map((m, i) => {
                const statusBadge = i === 0
                    ? '<span class="badge badge-win">Best</span>'
                    : m.days < 30
                        ? '<span class="badge badge-pending">Tracking</span>'
                        : '';
                const name = m.source.replace('open_meteo_', '').replace('_', ' ').toUpperCase();
                const biasClass = Math.abs(m.bias) > 2 ? 'negative' : '';
                return `<tr>
                    <td>${name}</td>
                    <td>${m.days}</td>
                    <td>${m.total_forecasts}</td>
                    <td>${m.mae}°F</td>
                    <td class="${biasClass}">${m.bias > 0 ? '+' : ''}${m.bias}°F</td>
                    <td>${statusBadge}</td>
                </tr>`;
            }).join('');
            document.getElementById('models-table').innerHTML = modelsHtml || '<tr><td colspan="6">No data yet - tracking will begin after first forecast run</td></tr>';

            // Recent forecasts table
            const recent = (data.recent_forecasts || []).slice(0, 50);
            const recentHtml = recent.map(f => {
                const errorClass = Math.abs(f.error) <= 2 ? 'positive' : Math.abs(f.error) <= 4 ? '' : 'negative';
                const modelName = f.source.replace('open_meteo_', '').replace('_', ' ').toUpperCase();
                return `<tr>
                    <td>${f.date}</td>
                    <td>${f.city_key.replace('HIGH', '')}</td>
                    <td>${modelName}</td>
                    <td>${f.forecast}°F</td>
                    <td>${f.observed}°F</td>
                    <td class="${errorClass}">${f.error > 0 ? '+' : ''}${f.error}°F</td>
                </tr>`;
            }).join('');
            document.getElementById('models-recent-table').innerHTML = recentHtml || '<tr><td colspan="6">No recent forecasts with observed data</td></tr>';
        }

        loadData();
    </script>
</body>
</html>
