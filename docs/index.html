<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0f1419;
            color: #e7e9ea;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #2f3336;
        }
        h1 {
            font-size: 2rem;
            margin-bottom: 8px;
        }
        .subtitle {
            color: #71767b;
            font-size: 0.9rem;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .grid-wide {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: #16181c;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #2f3336;
        }
        .card-full {
            grid-column: 1 / -1;
        }
        .card h2 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #71767b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        .stat {
            text-align: center;
        }
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #fff;
        }
        .stat-value.positive { color: #00ba7c; }
        .stat-value.negative { color: #f4212e; }
        .stat-label {
            font-size: 0.8rem;
            color: #71767b;
            margin-top: 4px;
        }
        .section {
            margin-bottom: 30px;
        }
        .section h2 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #2f3336;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #2f3336;
        }
        th {
            color: #71767b;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.75rem;
        }
        tr:hover {
            background: #1d1f23;
        }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge-win { background: #00ba7c22; color: #00ba7c; }
        .badge-loss { background: #f4212e22; color: #f4212e; }
        .badge-pending { background: #ffd40022; color: #ffd400; }
        .badge-yes { background: #1d9bf022; color: #1d9bf0; }
        .badge-no { background: #7856ff22; color: #7856ff; }
        .chart-container {
            position: relative;
            height: 280px;
            margin-top: 15px;
        }
        .chart-container-tall {
            position: relative;
            height: 350px;
            margin-top: 15px;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background: #16181c;
            border: 1px solid #2f3336;
            border-radius: 8px;
            cursor: pointer;
            color: #71767b;
            transition: all 0.2s;
        }
        .tab:hover {
            background: #1d1f23;
        }
        .tab.active {
            background: #1d9bf0;
            border-color: #1d9bf0;
            color: #fff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #71767b;
        }
        .ev-bucket-table td:first-child {
            font-weight: 600;
        }
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            font-size: 0.8rem;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        @media (max-width: 768px) {
            .stat-grid {
                grid-template-columns: 1fr;
            }
            .grid, .grid-wide {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Trading Dashboard</h1>
            <p class="subtitle">Props & Weather Auto-Trading Performance</p>
            <p class="subtitle" id="lastUpdated"></p>
        </header>

        <div class="tabs">
            <div class="tab active" data-tab="weather">Weather</div>
            <div class="tab" data-tab="props">Props</div>
        </div>

        <!-- Weather Tab -->
        <div id="weather-tab" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <h2>Performance</h2>
                    <div class="stat-grid">
                        <div class="stat">
                            <div class="stat-value" id="weather-record">-</div>
                            <div class="stat-label">Record</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="weather-roi">-</div>
                            <div class="stat-label">ROI</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="weather-trades">-</div>
                            <div class="stat-label">Total Trades</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="weather-avg-ev">-</div>
                            <div class="stat-label">Avg EV</div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h2>P&L</h2>
                    <div class="stat-grid">
                        <div class="stat">
                            <div class="stat-value" id="weather-cost">-</div>
                            <div class="stat-label">Total Cost</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="weather-payout">-</div>
                            <div class="stat-label">Total Payout</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="weather-profit">-</div>
                            <div class="stat-label">Net Profit</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="weather-pending">-</div>
                            <div class="stat-label">Pending</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid-wide">
                <div class="card">
                    <h2>Cumulative P&L Over Time</h2>
                    <div class="chart-container-tall">
                        <canvas id="weather-pnl-chart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2>Expected EV vs Realized ROI</h2>
                    <div class="chart-container-tall">
                        <canvas id="weather-ev-vs-realized-chart"></canvas>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #1d9bf0;"></div>
                            <span>Expected EV</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #00ba7c;"></div>
                            <span>Realized ROI</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid-wide">
                <div class="card">
                    <h2>Win Rate by City</h2>
                    <div class="chart-container">
                        <canvas id="weather-city-chart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2>Trade Distribution by EV</h2>
                    <div class="chart-container">
                        <canvas id="weather-ev-dist-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Results by EV Bucket</h2>
                <div class="card">
                    <table class="ev-bucket-table">
                        <thead>
                            <tr>
                                <th>EV Bucket</th>
                                <th>Trades</th>
                                <th>W-L-P</th>
                                <th>Win Rate</th>
                                <th>Avg Price</th>
                                <th>Expected EV</th>
                                <th>Realized ROI</th>
                            </tr>
                        </thead>
                        <tbody id="weather-ev-buckets"></tbody>
                    </table>
                </div>
            </div>

            <div class="section">
                <h2>Results by City</h2>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>City</th>
                                <th>Trades</th>
                                <th>Wins</th>
                                <th>Losses</th>
                                <th>Win Rate</th>
                                <th>Avg EV</th>
                            </tr>
                        </thead>
                        <tbody id="weather-cities"></tbody>
                    </table>
                </div>
            </div>

            <div class="section">
                <h2>Recent Trades</h2>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>City</th>
                                <th>Event</th>
                                <th>Side</th>
                                <th>Price</th>
                                <th>EV</th>
                                <th>Result</th>
                            </tr>
                        </thead>
                        <tbody id="weather-trades-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Props Tab -->
        <div id="props-tab" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>Performance</h2>
                    <div class="stat-grid">
                        <div class="stat">
                            <div class="stat-value" id="props-trades">-</div>
                            <div class="stat-label">Total Trades</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="props-filled">-</div>
                            <div class="stat-label">Filled</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="props-avg-edge">-</div>
                            <div class="stat-label">Avg Edge</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="props-cost">-</div>
                            <div class="stat-label">Total Cost</div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h2>By Stat Type</h2>
                    <div class="chart-container">
                        <canvas id="props-stat-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid-wide">
                <div class="card">
                    <h2>Cumulative Cost Over Time</h2>
                    <div class="chart-container-tall">
                        <canvas id="props-pnl-chart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2>Edge Distribution</h2>
                    <div class="chart-container-tall">
                        <canvas id="props-edge-dist-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Recent Trades</h2>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Player</th>
                                <th>Stat</th>
                                <th>Line</th>
                                <th>Side</th>
                                <th>Price</th>
                                <th>Edge</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="props-trades-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
            });
        });

        // Format helpers
        const fmt = {
            pct: (v) => v != null ? `${(v * 100).toFixed(1)}%` : '-',
            pctNum: (v) => v != null ? `${v.toFixed(1)}%` : '-',
            cents: (v) => v != null ? `$${(v / 100).toFixed(2)}` : '-',
            date: (v) => v ? new Date(v).toLocaleDateString() : '-',
        };

        // Chart.js defaults for dark theme
        Chart.defaults.color = '#71767b';
        Chart.defaults.borderColor = '#2f3336';

        // Load and render data
        async function loadData() {
            try {
                const [summaryRes, weatherRes, propsRes] = await Promise.all([
                    fetch('data/summary.json'),
                    fetch('data/weather.json'),
                    fetch('data/props.json'),
                ]);

                const summary = await summaryRes.json();
                const weather = await weatherRes.json();
                const props = await propsRes.json();

                renderWeather(weather);
                renderProps(props);

                document.getElementById('lastUpdated').textContent =
                    `Last updated: ${new Date(summary.generated_at).toLocaleString()}`;
            } catch (err) {
                console.error('Failed to load data:', err);
            }
        }

        function renderWeather(data) {
            // Summary stats
            document.getElementById('weather-record').textContent =
                `${data.wins}W - ${data.losses}L`;
            document.getElementById('weather-roi').textContent = fmt.pctNum(data.roi);
            document.getElementById('weather-roi').classList.add(data.roi >= 0 ? 'positive' : 'negative');
            document.getElementById('weather-trades').textContent = data.total_trades;
            document.getElementById('weather-avg-ev').textContent = fmt.pct(data.avg_ev);
            document.getElementById('weather-cost').textContent = fmt.cents(data.total_cost_cents);
            document.getElementById('weather-payout').textContent = fmt.cents(data.total_payout_cents);
            const profit = data.total_payout_cents - data.total_cost_cents;
            document.getElementById('weather-profit').textContent = fmt.cents(profit);
            document.getElementById('weather-profit').classList.add(profit >= 0 ? 'positive' : 'negative');
            document.getElementById('weather-pending').textContent = data.pending;

            // Cumulative P&L Chart
            const trades = (data.trades || []).slice().reverse(); // oldest first
            let cumPnl = 0;
            const pnlData = trades.filter(t => t.settled).map((t, i) => {
                const cost = t.fill_price_cents || t.limit_price_cents || 0;
                const payout = t.won ? 100 : 0;
                cumPnl += (payout - cost);
                return { x: i + 1, y: cumPnl / 100 };
            });

            if (pnlData.length > 0) {
                new Chart(document.getElementById('weather-pnl-chart'), {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Cumulative P&L ($)',
                            data: pnlData,
                            borderColor: '#1d9bf0',
                            backgroundColor: '#1d9bf022',
                            fill: true,
                            tension: 0.3,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { type: 'linear', title: { display: true, text: 'Trade #' } },
                            y: { title: { display: true, text: 'P&L ($)' } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // EV vs Realized ROI Chart
            const evBuckets = ['0-5%', '5-10%', '10-15%', '15-20%', '20%+'];
            const evMidpoints = [2.5, 7.5, 12.5, 17.5, 25]; // midpoint EV for each bucket
            const expectedEV = [];
            const realizedROI = [];

            evBuckets.forEach((bucket, i) => {
                const b = data.by_ev_bucket[bucket];
                if (b && b.count > 0) {
                    expectedEV.push(evMidpoints[i]);
                    realizedROI.push(b.roi || 0);
                } else {
                    expectedEV.push(evMidpoints[i]);
                    realizedROI.push(null);
                }
            });

            new Chart(document.getElementById('weather-ev-vs-realized-chart'), {
                type: 'bar',
                data: {
                    labels: evBuckets,
                    datasets: [
                        {
                            label: 'Expected EV (%)',
                            data: expectedEV,
                            backgroundColor: '#1d9bf0',
                            borderRadius: 4,
                        },
                        {
                            label: 'Realized ROI (%)',
                            data: realizedROI,
                            backgroundColor: '#00ba7c',
                            borderRadius: 4,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { title: { display: true, text: 'Percentage (%)' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // City Win Rate Chart
            const cities = Object.entries(data.by_city || {}).sort((a, b) => b[1].count - a[1].count);
            if (cities.length > 0) {
                const cityLabels = cities.map(c => c[0]);
                const cityWinRates = cities.map(c => {
                    const total = (c[1].wins || 0) + (c[1].losses || 0);
                    return total > 0 ? ((c[1].wins || 0) / total * 100) : 0;
                });

                new Chart(document.getElementById('weather-city-chart'), {
                    type: 'bar',
                    data: {
                        labels: cityLabels,
                        datasets: [{
                            label: 'Win Rate (%)',
                            data: cityWinRates,
                            backgroundColor: '#7856ff',
                            borderRadius: 4,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        scales: {
                            x: { max: 100, title: { display: true, text: 'Win Rate (%)' } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // EV Distribution Chart
            const evCounts = evBuckets.map(bucket => {
                const b = data.by_ev_bucket[bucket];
                return b ? b.count : 0;
            });

            new Chart(document.getElementById('weather-ev-dist-chart'), {
                type: 'doughnut',
                data: {
                    labels: evBuckets,
                    datasets: [{
                        data: evCounts,
                        backgroundColor: ['#71767b', '#ffd400', '#00ba7c', '#1d9bf0', '#7856ff'],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#e7e9ea' }
                        }
                    }
                }
            });

            // EV Buckets Table (enhanced)
            const evHtml = evBuckets.map((bucket, i) => {
                const b = data.by_ev_bucket[bucket] || { count: 0, wins: 0, losses: 0, pending: 0, total_cost_cents: 0, total_payout_cents: 0, roi: 0 };
                const roiClass = b.roi >= 0 ? 'positive' : 'negative';
                const totalSettled = (b.wins || 0) + (b.losses || 0);
                const winRate = totalSettled > 0 ? ((b.wins || 0) / totalSettled * 100).toFixed(0) : '-';
                const avgPrice = b.count > 0 ? (b.total_cost_cents / b.count).toFixed(0) : '-';
                return `<tr>
                    <td>${bucket}</td>
                    <td>${b.count}</td>
                    <td>${b.wins}-${b.losses}-${b.pending}</td>
                    <td>${winRate}%</td>
                    <td>${avgPrice}¢</td>
                    <td>${evMidpoints[i]}%</td>
                    <td class="${roiClass}">${fmt.pctNum(b.roi)}</td>
                </tr>`;
            }).join('');
            document.getElementById('weather-ev-buckets').innerHTML = evHtml;

            // Cities Table (enhanced)
            const cityHtml = cities.map(([city, stats]) => {
                const totalSettled = (stats.wins || 0) + (stats.losses || 0);
                const winRate = totalSettled > 0 ? ((stats.wins || 0) / totalSettled * 100).toFixed(0) : '-';
                return `<tr>
                    <td>${city}</td>
                    <td>${stats.count}</td>
                    <td>${stats.wins || 0}</td>
                    <td>${stats.losses || 0}</td>
                    <td>${winRate}%</td>
                    <td>${fmt.pct(stats.avg_ev)}</td>
                </tr>`;
            }).join('');
            document.getElementById('weather-cities').innerHTML = cityHtml || '<tr><td colspan="6">No data</td></tr>';

            // Trades table
            const tradesHtml = (data.trades || []).slice(0, 20).map(t => {
                let resultBadge = '<span class="badge badge-pending">Pending</span>';
                if (t.settled) {
                    resultBadge = t.won
                        ? '<span class="badge badge-win">Win</span>'
                        : '<span class="badge badge-loss">Loss</span>';
                }
                const sideBadge = t.side === 'YES'
                    ? '<span class="badge badge-yes">YES</span>'
                    : '<span class="badge badge-no">NO</span>';
                return `<tr>
                    <td>${t.trade_date}</td>
                    <td>${t.city_key}</td>
                    <td>${t.event_display}</td>
                    <td>${sideBadge}</td>
                    <td>${t.fill_price_cents || t.limit_price_cents}¢</td>
                    <td>${fmt.pct(t.ev)}</td>
                    <td>${resultBadge}</td>
                </tr>`;
            }).join('');
            document.getElementById('weather-trades-table').innerHTML = tradesHtml || '<tr><td colspan="7">No trades</td></tr>';
        }

        function renderProps(data) {
            document.getElementById('props-trades').textContent = data.total_trades;
            document.getElementById('props-filled').textContent = data.filled_trades;
            document.getElementById('props-avg-edge').textContent = fmt.pct(data.avg_edge);
            document.getElementById('props-cost').textContent = fmt.cents(data.total_cost_cents);

            // Cumulative Cost Chart
            const trades = (data.trades || []).slice().reverse(); // oldest first
            let cumCost = 0;
            const costData = trades.map((t, i) => {
                cumCost += (t.fill_price_cents || t.limit_price_cents || 0);
                return { x: i + 1, y: cumCost / 100 };
            });

            if (costData.length > 0) {
                new Chart(document.getElementById('props-pnl-chart'), {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Cumulative Cost ($)',
                            data: costData,
                            borderColor: '#ffd400',
                            backgroundColor: '#ffd40022',
                            fill: true,
                            tension: 0.3,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { type: 'linear', title: { display: true, text: 'Trade #' } },
                            y: { title: { display: true, text: 'Cost ($)' } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // Edge Distribution Histogram
            const edges = trades.map(t => (t.edge || 0) * 100);
            const edgeBuckets = ['0-5%', '5-10%', '10-15%', '15-20%', '20%+'];
            const edgeCounts = [0, 0, 0, 0, 0];
            edges.forEach(e => {
                if (e < 5) edgeCounts[0]++;
                else if (e < 10) edgeCounts[1]++;
                else if (e < 15) edgeCounts[2]++;
                else if (e < 20) edgeCounts[3]++;
                else edgeCounts[4]++;
            });

            new Chart(document.getElementById('props-edge-dist-chart'), {
                type: 'bar',
                data: {
                    labels: edgeBuckets,
                    datasets: [{
                        label: 'Trades',
                        data: edgeCounts,
                        backgroundColor: '#1d9bf0',
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { title: { display: true, text: 'Number of Trades' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // Trades table
            const tradesHtml = (data.trades || []).slice(0, 20).map(t => {
                const sideBadge = t.side === 'over'
                    ? '<span class="badge badge-yes">OVER</span>'
                    : '<span class="badge badge-no">UNDER</span>';
                return `<tr>
                    <td>${t.trade_date}</td>
                    <td>${t.player_name}</td>
                    <td>${t.stat_type}</td>
                    <td>${t.line}</td>
                    <td>${sideBadge}</td>
                    <td>${t.fill_price_cents || t.limit_price_cents}¢</td>
                    <td>${fmt.pct(t.edge)}</td>
                    <td>${t.status}</td>
                </tr>`;
            }).join('');
            document.getElementById('props-trades-table').innerHTML = tradesHtml || '<tr><td colspan="8">No trades</td></tr>';

            // Stat type chart
            const statTypes = Object.keys(data.by_stat_type || {});
            if (statTypes.length > 0) {
                new Chart(document.getElementById('props-stat-chart'), {
                    type: 'doughnut',
                    data: {
                        labels: statTypes,
                        datasets: [{
                            data: statTypes.map(s => data.by_stat_type[s].count),
                            backgroundColor: ['#1d9bf0', '#00ba7c', '#ffd400', '#7856ff', '#f4212e'],
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { color: '#e7e9ea' }
                            }
                        }
                    }
                });
            }
        }

        loadData();
    </script>
</body>
</html>
