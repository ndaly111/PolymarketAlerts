name: Weather - Forecast Snapshot (NWS hourly â†’ forecast_snapshots)

on:
  workflow_dispatch:
    inputs:
      snapshot_hour_local:
        description: "Hour in each city local time to snapshot (default: 4)"
        required: false
        default: "4"

permissions:
  contents: write

concurrency:
  # Manual tool: if you accidentally trigger twice, no need to queue.
  group: weather-forecast-snapshot
  cancel-in-progress: true

jobs:
  snapshot:
    runs-on: ubuntu-latest
    env:
      TZ: America/New_York
      PYTHONPATH: ${{ github.workspace }}
      WEATHER_SNAPSHOT_HOUR_LOCAL: ${{ github.event.inputs.snapshot_hour_local || '4' }}
      WEATHER_SNAPSHOT_MINUTE_MAX: "59"
      WEATHER_SNAPSHOT_LATE_WINDOW_HOURS: "3"
      # The NWS API expects a real contact in User-Agent; fall back to placeholder.
      NWS_USER_AGENT: "weather-edge-bot/0.1 (contact: ${{ secrets.NWS_CONTACT_EMAIL || 'you@example.com' }})"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r weather/requirements.txt

      - name: Collect snapshots
        run: |
          python -m weather.scripts.collect_forecast_snapshot

      - name: Commit snapshot changes (if any)
        run: |
          set -e
          if [[ -n "$(git status --porcelain weather/data)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add weather/data
            git commit -m "weather: add forecast snapshot(s)"
            ok=0
            for i in 1 2 3; do
              git pull --rebase && git push && ok=1 && break
              echo "Push failed (attempt $i). Retrying..."
              sleep 2
            done
            if [[ "$ok" != "1" ]]; then
              echo "ERROR: Could not push snapshot commit after 3 attempts."
              exit 1
            fi
          else
            echo "No snapshot changes to commit."
          fi
