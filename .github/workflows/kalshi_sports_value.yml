name: Kalshi vs Sportsbook - Lines Value Scan

on:
  schedule:
    # 6:05 AM America/New_York year-round (DST-safe via dual cron + gate)
    - cron: "5 10 * * *"  # 6:05 AM EDT
    - cron: "5 11 * * *"  # 6:05 AM EST
  workflow_dispatch:
    inputs:
      sport_preset:
        description: "Sports preset (Odds API keys)"
        type: choice
        options:
          - major_us
          - nfl
          - nba
          - mlb
          - nhl
          - ncaaf
          - ncaab
          - college
          - custom
        default: major_us
      sport_keys_custom:
        description: "Comma-separated Odds API sport keys (only if sport_preset=custom)"
        required: false
        default: ""
      top_n:
        description: "Number of results to keep/post"
        type: choice
        options: ["10", "25", "50", "100"]
        default: "25"
      min_edge:
        description: "Minimum edge (0.03 = 3 percentage points)"
        type: choice
        options: ["0.00", "0.01", "0.02", "0.03", "0.05"]
        default: "0.03"
      min_books:
        description: "Minimum books required for a fair probability"
        type: choice
        options: ["1", "2", "3", "4", "5"]
        default: "3"
      lookahead_hours:
        description: "Only consider Kalshi markets closing within this many hours"
        type: choice
        options: ["24", "48", "72", "168"]
        default: "72"
      buy_fee_cents:
        description: "Kalshi opening fee per contract (cents) added to YES/NO buy price"
        type: choice
        options: ["0", "1", "2", "3", "5"]
        default: "3"
      series_tickers:
        description: "Optional: comma-separated Kalshi series tickers (overrides auto-discovery)"
        required: false
        default: ""
      series_filter_preset:
        description: "Series filter preset"
        type: choice
        options:
          - default
          - lenient
          - strict
          - custom
        default: default
      series_category:
        description: "Kalshi series category label (usually 'Sports')"
        required: false
        default: "Sports"
      series_include_regex:
        description: "Include series when ticker/title matches (case-insensitive) - used only when preset=custom"
        required: false
        default: ""
      series_exclude_regex:
        description: "Exclude series when ticker/title matches (case-insensitive) - used only when preset=custom"
        required: false
        default: ""
      mve_filter:
        description: "MVE markets"
        type: choice
        options: ["all", "exclude", "only"]
        default: "all"
      max_series_tickers:
        description: "Max auto-discovered series tickers to scan"
        type: choice
        options: ["30", "60", "90", "120"]
        default: "60"
      debug_mode:
        description: "Debug: write top results even if below min_edge (no Discord post)"
        type: choice
        options: ["false", "true"]
        default: "false"

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install -q requests cryptography python-dateutil

      - name: Gate schedule to 6:05 AM America/New_York
        id: gate
        if: github.event_name == 'schedule'
        run: |
          python - <<'PY'
          from datetime import datetime
          from zoneinfo import ZoneInfo
          import os

          now = datetime.now(ZoneInfo('America/New_York'))
          should_run = (now.hour == 6 and 5 <= now.minute < 15)

          out = os.environ.get("GITHUB_OUTPUT")
          if out:
              with open(out, "a", encoding="utf-8") as f:
                  f.write(f"run={'true' if should_run else 'false'}\n")
          else:
              # Shouldn't happen in Actions, but makes local runs less confusing.
              print("WARNING: GITHUB_OUTPUT not set; cannot emit step output.")

          print("NY time:", now.isoformat())
          print("Gate decision:", should_run)
          PY

      - name: Run Kalshi scan
        if: github.event_name != 'schedule' || steps.gate.outputs.run == 'true'
        env:
          THE_ODDS_API: ${{ secrets.THE_ODDS_API || secrets.ODDS_API_KEY }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_SPORTS_ALERT || secrets.DISCORD_WEBHOOK_URL }}

          # Kalshi auth (required for trade-api/v2)
          KALSHI_KEY_ID: ${{ secrets.KALSHI_API_KEY_ID || secrets.KALSHI_KEY_ID }}
          KALSHI_PRIVATE_KEY: ${{ secrets.KALSHI_PRIVATE_KEY }}
          # Optional override; if omitted we fall back to the documented base host and ensure /trade-api/v2 exists
          KALSHI_BASE: ${{ vars.KALSHI_BASE || 'https://api.elections.kalshi.com/trade-api/v2' }}

          SPORT_KEYS: ${{ github.event.inputs.sport_preset == 'nfl' && 'americanfootball_nfl' || github.event.inputs.sport_preset == 'nba' && 'basketball_nba' || github.event.inputs.sport_preset == 'mlb' && 'baseball_mlb' || github.event.inputs.sport_preset == 'nhl' && 'icehockey_nhl' || github.event.inputs.sport_preset == 'ncaaf' && 'americanfootball_ncaaf' || github.event.inputs.sport_preset == 'ncaab' && 'basketball_ncaab' || github.event.inputs.sport_preset == 'college' && 'americanfootball_ncaaf,basketball_ncaab' || github.event.inputs.sport_preset == 'custom' && github.event.inputs.sport_keys_custom || 'americanfootball_nfl,basketball_nba,baseball_mlb,icehockey_nhl,americanfootball_ncaaf,basketball_ncaab' }}
          TOP_N: ${{ github.event.inputs.top_n || '25' }}
          MIN_EDGE: ${{ github.event.inputs.min_edge || '0.03' }}
          MIN_BOOKS: ${{ github.event.inputs.min_books || '3' }}
          DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}

          KALSHI_LOOKAHEAD_HOURS: ${{ github.event.inputs.lookahead_hours || '72' }}
          KALSHI_BUY_FEE_CENTS: ${{ github.event.inputs.buy_fee_cents || '3' }}
          KALSHI_SERIES_TICKERS: ${{ github.event.inputs.series_tickers || '' }}
          KALSHI_SERIES_CATEGORY: ${{ github.event.inputs.series_category || 'Sports' }}
          # Only ML / spread / totals; avoid tennis/golf “MATCH/SET/DISTANCE” rabbit holes.
          KALSHI_SPORTS_SERIES_INCLUDE_REGEX: ${{ github.event.inputs.series_filter_preset == 'strict' && '(MONEYLINE|H2H|SPREAD|TOTAL|OVER|UNDER)' || github.event.inputs.series_filter_preset == 'lenient' && '(GAME|MONEYLINE|H2H|SPREAD|TOTAL|OVER|UNDER)' || github.event.inputs.series_filter_preset == 'custom' && github.event.inputs.series_include_regex || '(GAME|MONEYLINE|H2H|SPREAD|TOTAL|OVER|UNDER)' }}
          KALSHI_SPORTS_SERIES_EXCLUDE_REGEX: ${{ github.event.inputs.series_filter_preset == 'custom' && github.event.inputs.series_exclude_regex || '(PROP|PLAYER|MVP|CHAMP|TROPHY|AWARD|SEASON|FUTURE|FUTURES|WINS|EXACT|COMBO|PARLAY|PACK|SALE|COACH|TOP\\s*\\d|ALT|ALTERNATE|ATP|WTA|TENNIS|GOLF)' }}
          KALSHI_MVE_FILTER: ${{ github.event.inputs.mve_filter || 'all' }}
          KALSHI_MAX_SERIES_TICKERS: ${{ github.event.inputs.max_series_tickers || '60' }}
          # Ping Discord on manual runs even if 0 plays (so you know the job ran)
          ALWAYS_NOTIFY: ${{ github.event_name == 'workflow_dispatch' && 'true' || 'false' }}

          OUTDIR: out
        run: |
          python kalshi_sports_value.py

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kalshi-value-output
          path: out/
          if-no-files-found: warn
          retention-days: 14
