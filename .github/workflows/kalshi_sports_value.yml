name: Kalshi vs Sportsbook - Lines Value Scan

on:
  schedule:
    # Hourly scan
    - cron: "0 * * * *"
  workflow_dispatch:
    inputs:
      mode:
        description: "Run mode"
        required: false
        type: choice
        options: ["prod", "debug", "wide"]
        default: "prod"
      sport_preset:
        description: "Sports preset (Odds API sport keys)"
        type: choice
        options:
          - all
          - nfl
          - nba
          - mlb
          - nhl
          - ncaaf
          - ncaab
          - college
          - tennis
          - custom
        default: all
      sport_keys_custom:
        description: "Comma-separated Odds API sport keys (only when preset=custom)"
        required: false
        default: ""
      top_n:
        description: "Number of results to post"
        required: false
        default: "25"
      min_edge:
        description: "Minimum edge (probability points; 0.02 = 2pp)"
        required: false
        default: "0.02"
      show_all_edges:
        description: "Show ALL edges (bypass MIN_EDGE filter for debugging)"
        type: choice
        options: ["false", "true"]
        default: "false"
      min_volume:
        description: "Minimum Kalshi volume to include (0 disables volume filter)"
        required: false
        default: "0"
      master_debug:
        description: "MASTER DEBUG: save raw Kalshi API request/response artifacts (secrets redacted)"
        type: choice
        options: ["false", "true"]
        default: "false"
      master_debug_max:
        description: "MASTER DEBUG: max number of requests to save (higher = larger artifacts)"
        required: false
        default: "250"
      volume_missing_policy:
        description: "Volume missing policy: include=keep unknown volume; exclude=drop unknown volume"
        type: choice
        options: ["include", "exclude"]
        default: "include"
      min_books:
        description: "Minimum sportsbook books required (1 disables this filter)"
        required: false
        default: "1"
      game_lookahead_hours:
        description: "Only consider games starting within N hours (set 0 to disable)"
        required: false
        default: "24"
      lookahead_hours:
        description: "Kalshi market close-time lookahead window in hours (set 0 to disable)"
        required: false
        default: "72"
      buy_fee_cents:
        description: "Kalshi buy fee in cents per contract (e.g., 2)"
        required: false
        default: "2"
      fail_on_no_odds_events:
        description: "Fail the job if sportsbook odds are unavailable (default: skip with a warning)"
        required: false
        type: choice
        options: ["0", "1"]
        default: "0"

concurrency:
  group: kalshi-sports-value
  cancel-in-progress: false

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install -q requests cryptography python-dateutil

      - name: Run Kalshi scan
        env:
          THE_ODDS_API: ${{ secrets.THE_ODDS_API || secrets.ODDS_API_KEY }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_SPORTS_ALERT || secrets.DISCORD_WEBHOOK_URL }}

          # Kalshi auth (required for trade-api/v2)
          KALSHI_KEY_ID: ${{ secrets.KALSHI_API_KEY_ID || secrets.KALSHI_KEY_ID }}
          KALSHI_PRIVATE_KEY: ${{ secrets.KALSHI_PRIVATE_KEY }}
          # Official base host default; override via repo var if you ever need to.
          KALSHI_BASE: ${{ vars.KALSHI_BASE || 'https://api.elections.kalshi.com/trade-api/v2' }}

          # Tennis keys: Grand Slams + Masters 1000 (only active during tournaments)
          SPORT_KEYS: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.sport_preset == 'nfl' && 'americanfootball_nfl' || github.event.inputs.sport_preset == 'nba' && 'basketball_nba' || github.event.inputs.sport_preset == 'mlb' && 'baseball_mlb' || github.event.inputs.sport_preset == 'nhl' && 'icehockey_nhl' || github.event.inputs.sport_preset == 'ncaaf' && 'americanfootball_ncaaf' || github.event.inputs.sport_preset == 'ncaab' && 'basketball_ncaab' || github.event.inputs.sport_preset == 'college' && 'americanfootball_ncaaf,basketball_ncaab' || github.event.inputs.sport_preset == 'tennis' && 'tennis_atp_aus_open_singles,tennis_atp_french_open,tennis_atp_wimbledon,tennis_atp_us_open,tennis_wta_aus_open_singles,tennis_wta_french_open,tennis_wta_wimbledon,tennis_wta_us_open,tennis_atp_indian_wells,tennis_atp_miami_open,tennis_atp_monte_carlo_masters,tennis_atp_madrid_open,tennis_atp_italian_open,tennis_atp_canadian_open,tennis_atp_cincinnati_open,tennis_atp_shanghai_masters,tennis_atp_paris_masters,tennis_wta_indian_wells,tennis_wta_miami_open,tennis_wta_madrid_open,tennis_wta_italian_open,tennis_wta_canadian_open,tennis_wta_cincinnati_open' || github.event.inputs.sport_preset == 'custom' && github.event.inputs.sport_keys_custom || 'americanfootball_nfl,basketball_nba,baseball_mlb,icehockey_nhl,americanfootball_ncaaf,basketball_ncaab,tennis_atp_aus_open_singles,tennis_atp_french_open,tennis_atp_wimbledon,tennis_atp_us_open,tennis_wta_aus_open_singles,tennis_wta_french_open,tennis_wta_wimbledon,tennis_wta_us_open,tennis_atp_indian_wells,tennis_atp_miami_open,tennis_atp_monte_carlo_masters,tennis_atp_madrid_open,tennis_atp_italian_open,tennis_atp_canadian_open,tennis_atp_cincinnati_open,tennis_atp_shanghai_masters,tennis_atp_paris_masters,tennis_wta_indian_wells,tennis_wta_miami_open,tennis_wta_madrid_open,tennis_wta_italian_open,tennis_wta_canadian_open,tennis_wta_cincinnati_open') || 'americanfootball_nfl,basketball_nba,baseball_mlb,icehockey_nhl,americanfootball_ncaaf,basketball_ncaab,tennis_atp_aus_open_singles,tennis_atp_french_open,tennis_atp_wimbledon,tennis_atp_us_open,tennis_wta_aus_open_singles,tennis_wta_french_open,tennis_wta_wimbledon,tennis_wta_us_open,tennis_atp_indian_wells,tennis_atp_miami_open,tennis_atp_monte_carlo_masters,tennis_atp_madrid_open,tennis_atp_italian_open,tennis_atp_canadian_open,tennis_atp_cincinnati_open,tennis_atp_shanghai_masters,tennis_atp_paris_masters,tennis_wta_indian_wells,tennis_wta_miami_open,tennis_wta_madrid_open,tennis_wta_italian_open,tennis_wta_canadian_open,tennis_wta_cincinnati_open' }}

          TOP_N: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.top_n) || vars.KALSHI_TOP_N || '25' }}
          MIN_EDGE: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.min_edge) || vars.KALSHI_MIN_EDGE || '0.02' }}
          SHOW_ALL_EDGES: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.show_all_edges) || 'false' }}
          # Single-mode debug control:
          # - prod  => normal behavior
          # - debug => keep filters, but show/debug more
          # - wide  => debug + widen scan (optionally disables some gating)
          KALSHI_MODE: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.mode) || 'prod' }}
          DEBUG_MODE: ${{ ((github.event_name == 'workflow_dispatch' && github.event.inputs.mode) || 'prod') != 'prod' && 'true' || 'false' }}
          KALSHI_DEBUG_WIDE_SCAN: ${{ ((github.event_name == 'workflow_dispatch' && github.event.inputs.mode) || 'prod') == 'wide' && 'true' || 'false' }}
          KALSHI_NO_FILTERS: ${{ ((github.event_name == 'workflow_dispatch' && github.event.inputs.mode) || 'prod') == 'wide' && 'true' || (vars.KALSHI_NO_FILTERS || 'false') }}

          # Allow per-run overrides (workflow_dispatch); otherwise use repo Variables/defaults
          MIN_BOOKS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.min_books || vars.KALSHI_MIN_BOOKS || '1' }}
          KALSHI_LOOKAHEAD_HOURS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.lookahead_hours || vars.KALSHI_LOOKAHEAD_HOURS || '72' }}
          KALSHI_GAME_LOOKAHEAD_HOURS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.game_lookahead_hours || vars.KALSHI_GAME_LOOKAHEAD_HOURS || '24' }}
          KALSHI_BUY_FEE_CENTS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.buy_fee_cents || vars.KALSHI_BUY_FEE_CENTS || '2' }}
          # Default to 0 so the scanner actually produces candidates out of the box.
          # Once matching is validated, set a higher repo Variable (KALSHI_MIN_VOLUME)
          # for production-quality liquidity filtering.
          KALSHI_MIN_VOLUME: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.min_volume || vars.KALSHI_MIN_VOLUME || '0' }}

          # Guard against cross-date fuzzy matches (hours difference between Odds commence_time and Kalshi close time).
          KALSHI_MATCH_MAX_TIME_SKEW_HOURS: ${{ vars.KALSHI_MATCH_MAX_TIME_SKEW_HOURS || '48' }}
          # Only loosen matching if you explicitly enable it for debugging.
          KALSHI_DEBUG_LOOSE_MATCH: ${{ vars.KALSHI_DEBUG_LOOSE_MATCH || 'false' }}
          # If DEBUG_MODE=true and you want orderbook requests even when prices exist, set to true.
          KALSHI_DEBUG_FORCE_ORDERBOOK: ${{ vars.KALSHI_DEBUG_FORCE_ORDERBOOK || 'false' }}
          # Pipeline report artifacts (ingest + per-filter stage counts + samples)
          KALSHI_PIPELINE_REPORT: ${{ vars.KALSHI_PIPELINE_REPORT || 'true' }}
          KALSHI_VOLUME_MISSING_POLICY: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.volume_missing_policy) || vars.KALSHI_VOLUME_MISSING_POLICY || 'include' }}
          MASTER_DEBUG: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.master_debug) || vars.KALSHI_MASTER_DEBUG || 'false' }}
          MASTER_DEBUG_MAX: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.master_debug_max) || vars.KALSHI_MASTER_DEBUG_MAX || '250' }}
          # Optional: cap each saved response size (KB). Set as a repo var if you want.
          MASTER_DEBUG_MAX_KB: ${{ vars.KALSHI_MASTER_DEBUG_MAX_KB || '512' }}
          KALSHI_USE_ORDERBOOK: ${{ vars.KALSHI_USE_ORDERBOOK || 'true' }}
          KALSHI_ORDERBOOK_MAX_CALLS: ${{ vars.KALSHI_ORDERBOOK_MAX_CALLS || '300' }}
          KALSHI_SERIES_MIN_SCORE: ${{ vars.KALSHI_SERIES_MIN_SCORE || '8' }}
          KALSHI_MAX_SERIES_TICKERS: ${{ vars.KALSHI_MAX_SERIES_TICKERS || '60' }}
          KALSHI_MVE_FILTER: ${{ vars.KALSHI_MVE_FILTER || 'all' }}
          KALSHI_SERIES_TICKERS: ${{ vars.KALSHI_SERIES_TICKERS || '' }}
          KALSHI_SERIES_CATEGORY: ${{ vars.KALSHI_SERIES_CATEGORY || 'Sports' }}
          KALSHI_SPORTS_SERIES_INCLUDE_REGEX: ${{ vars.KALSHI_SPORTS_SERIES_INCLUDE_REGEX || '(GAME|MONEYLINE|H2H|SPREAD|TOTAL|OVER|UNDER)' }}
          KALSHI_SPORTS_SERIES_EXCLUDE_REGEX: ${{ vars.KALSHI_SPORTS_SERIES_EXCLUDE_REGEX || '(PROP|PLAYER|MVP|CHAMP|TROPHY|AWARD|SEASON|FUTURE|FUTURES|WINS|EXACT|COMBO|PARLAY|PACK|SALE|COACH|TOP\\s*\\d|ALT|ALTERNATE|GOLF|MATCH\\s*BET)' }}
          KALSHI_MIN_CLOSE_BUFFER_HOURS: ${{ vars.KALSHI_MIN_CLOSE_BUFFER_HOURS || '0' }}

          # Ping Discord on manual runs even if 0 plays (so you know the job ran)
          ALWAYS_NOTIFY: ${{ github.event_name == 'workflow_dispatch' && 'true' || 'false' }}

          # If no sportsbook odds are available (Odds API quota exhausted, DK blocked, etc.),
          # default is to skip with a warning (exit 0). Set to 1 to hard-fail.
          FAIL_ON_NO_ODDS_EVENTS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.fail_on_no_odds_events || vars.KALSHI_FAIL_ON_NO_ODDS_EVENTS || '0' }}

          OUTDIR: out
        run: |
          python kalshi_sports_value.py

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kalshi-value-output
          path: out/
          if-no-files-found: warn
          retention-days: 14
