name: Kalshi vs Sportsbook - Lines Value Scan

on:
  schedule:
    # 6:05 AM America/New_York year-round (DST-safe via dual cron + gate)
    - cron: "5 10 * * *"  # 6:05 AM EDT
    - cron: "5 11 * * *"  # 6:05 AM EST
  workflow_dispatch:
    inputs:
      sport_preset:
        description: "Sports preset (Odds API sport keys)"
        type: choice
        options:
          - all
          - nfl
          - nba
          - mlb
          - nhl
          - ncaaf
          - ncaab
          - college
          - custom
        default: all
      sport_keys_custom:
        description: "Comma-separated Odds API sport keys (only when preset=custom)"
        required: false
        default: ""
      top_n:
        description: "Number of results to post"
        required: false
        default: "25"
      min_edge:
        description: "Minimum edge (probability points; 0.03 = 3pp)"
        required: false
        default: "0.03"
      min_volume:
        description: "Minimum Kalshi volume to include (0 disables volume filter)"
        required: false
        default: "1000"
      master_debug:
        description: "MASTER DEBUG: save raw Kalshi API request/response artifacts (secrets redacted)"
        type: choice
        options: ["false", "true"]
        default: "false"
      master_debug_max:
        description: "MASTER DEBUG: max number of requests to save (higher = larger artifacts)"
        required: false
        default: "250"
      volume_missing_policy:
        description: "Volume missing policy: include=keep unknown volume; exclude=drop unknown volume"
        type: choice
        options: ["include", "exclude"]
        default: "include"
      min_books:
        description: "Minimum sportsbook books required (1 disables this filter)"
        required: false
        default: "3"
      game_lookahead_hours:
        description: "Only consider games starting within N hours (set 0 to disable)"
        required: false
        default: "24"
      lookahead_hours:
        description: "Kalshi market close-time lookahead window in hours (set 0 to disable)"
        required: false
        default: "72"
      buy_fee_cents:
        description: "Kalshi buy fee in cents per contract (e.g., 2)"
        required: false
        default: "2"
      debug_mode:
        description: "Debug: write extra artifacts and skip Discord"
        type: choice
        options: ["false", "true"]
        default: "false"
      debug_wide_scan:
        description: "DEBUG only: remove close-window bounds (can be very slow)"
        type: choice
        options: ["false", "true"]
        default: "false"
      no_filters:
        description: "Disable most filters / widen windows (debugging: get anything to show)"
        required: false
        type: choice
        options: ["false", "true"]
        default: "false"

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install -q requests cryptography python-dateutil

      - name: Gate schedule to 6:05 AM America/New_York
        id: gate
        if: github.event_name == 'schedule'
        run: |
          python - <<'PY'
          from datetime import datetime
          from zoneinfo import ZoneInfo
          import os

          ny = ZoneInfo("America/New_York")
          now = datetime.now(tz=ny)
          should_run = (now.hour == 6 and 5 <= now.minute < 15)

          out = os.environ.get("GITHUB_OUTPUT")
          if out:
              with open(out, "a", encoding="utf-8") as f:
                  f.write(f"run={'true' if should_run else 'false'}\n")
          else:
              print("WARNING: GITHUB_OUTPUT not set; cannot emit step output.")

          print("NY time:", now.isoformat())
          print("Gate decision:", should_run)
          PY

      - name: Run Kalshi scan
        if: github.event_name != 'schedule' || steps.gate.outputs.run == 'true'
        env:
          THE_ODDS_API: ${{ secrets.THE_ODDS_API || secrets.ODDS_API_KEY }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_SPORTS_ALERT || secrets.DISCORD_WEBHOOK_URL }}

          # Kalshi auth (required for trade-api/v2)
          KALSHI_KEY_ID: ${{ secrets.KALSHI_API_KEY_ID || secrets.KALSHI_KEY_ID }}
          KALSHI_PRIVATE_KEY: ${{ secrets.KALSHI_PRIVATE_KEY }}
          # Official base host default; override via repo var if you ever need to.
          KALSHI_BASE: ${{ vars.KALSHI_BASE || 'https://api.elections.kalshi.com/trade-api/v2' }}

          SPORT_KEYS: ${{ github.event.inputs.sport_preset == 'nfl' && 'americanfootball_nfl' || github.event.inputs.sport_preset == 'nba' && 'basketball_nba' || github.event.inputs.sport_preset == 'mlb' && 'baseball_mlb' || github.event.inputs.sport_preset == 'nhl' && 'icehockey_nhl' || github.event.inputs.sport_preset == 'ncaaf' && 'americanfootball_ncaaf' || github.event.inputs.sport_preset == 'ncaab' && 'basketball_ncaab' || github.event.inputs.sport_preset == 'college' && 'americanfootball_ncaaf,basketball_ncaab' || github.event.inputs.sport_preset == 'custom' && github.event.inputs.sport_keys_custom || 'americanfootball_nfl,basketball_nba,baseball_mlb,icehockey_nhl,americanfootball_ncaaf,basketball_ncaab' }}

          TOP_N: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.top_n) || vars.KALSHI_TOP_N || '25' }}
          MIN_EDGE: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.min_edge) || vars.KALSHI_MIN_EDGE || '0.03' }}
          DEBUG_MODE: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.debug_mode) || 'false' }}
          KALSHI_DEBUG_WIDE_SCAN: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.debug_wide_scan) || 'false' }}
          KALSHI_NO_FILTERS: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.no_filters) || vars.KALSHI_NO_FILTERS || 'false' }}

          # Allow per-run overrides (workflow_dispatch); otherwise use repo Variables/defaults
          MIN_BOOKS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.min_books || vars.KALSHI_MIN_BOOKS || '3' }}
          KALSHI_LOOKAHEAD_HOURS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.lookahead_hours || vars.KALSHI_LOOKAHEAD_HOURS || '72' }}
          KALSHI_GAME_LOOKAHEAD_HOURS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.game_lookahead_hours || vars.KALSHI_GAME_LOOKAHEAD_HOURS || '24' }}
          KALSHI_BUY_FEE_CENTS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.buy_fee_cents || vars.KALSHI_BUY_FEE_CENTS || '2' }}
          KALSHI_MIN_VOLUME: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.min_volume || vars.KALSHI_MIN_VOLUME || '1000' }}
          KALSHI_VOLUME_MISSING_POLICY: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.volume_missing_policy) || vars.KALSHI_VOLUME_MISSING_POLICY || 'include' }}
          MASTER_DEBUG: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.master_debug) || vars.KALSHI_MASTER_DEBUG || 'false' }}
          MASTER_DEBUG_MAX: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.master_debug_max) || vars.KALSHI_MASTER_DEBUG_MAX || '250' }}
          # Optional: cap each saved response size (KB). Set as a repo var if you want.
          MASTER_DEBUG_MAX_KB: ${{ vars.KALSHI_MASTER_DEBUG_MAX_KB || '512' }}
          KALSHI_USE_ORDERBOOK: ${{ vars.KALSHI_USE_ORDERBOOK || 'true' }}
          KALSHI_ORDERBOOK_MAX_CALLS: ${{ vars.KALSHI_ORDERBOOK_MAX_CALLS || '300' }}
          KALSHI_SERIES_MIN_SCORE: ${{ vars.KALSHI_SERIES_MIN_SCORE || '8' }}
          KALSHI_MAX_SERIES_TICKERS: ${{ vars.KALSHI_MAX_SERIES_TICKERS || '60' }}
          KALSHI_MVE_FILTER: ${{ vars.KALSHI_MVE_FILTER || 'all' }}
          KALSHI_SERIES_TICKERS: ${{ vars.KALSHI_SERIES_TICKERS || '' }}
          KALSHI_SERIES_CATEGORY: ${{ vars.KALSHI_SERIES_CATEGORY || 'Sports' }}
          KALSHI_SPORTS_SERIES_INCLUDE_REGEX: ${{ vars.KALSHI_SPORTS_SERIES_INCLUDE_REGEX || '(GAME|MONEYLINE|H2H|SPREAD|TOTAL|OVER|UNDER)' }}
          KALSHI_SPORTS_SERIES_EXCLUDE_REGEX: ${{ vars.KALSHI_SPORTS_SERIES_EXCLUDE_REGEX || '(PROP|PLAYER|MVP|CHAMP|TROPHY|AWARD|SEASON|FUTURE|FUTURES|WINS|EXACT|COMBO|PARLAY|PACK|SALE|COACH|TOP\\s*\\d|ALT|ALTERNATE|ATP|WTA|TENNIS|GOLF|MATCH\\s*BET)' }}
          KALSHI_MIN_CLOSE_BUFFER_HOURS: ${{ vars.KALSHI_MIN_CLOSE_BUFFER_HOURS || '0' }}

          # Ping Discord on manual runs even if 0 plays (so you know the job ran)
          ALWAYS_NOTIFY: ${{ github.event_name == 'workflow_dispatch' && 'true' || 'false' }}

          OUTDIR: out
        run: |
          python kalshi_sports_value.py

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kalshi-value-output
          path: out/
          if-no-files-found: warn
          retention-days: 14
