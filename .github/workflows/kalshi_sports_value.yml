name: Kalshi vs Sportsbook - Lines Value Scan

on:
  schedule:
    # 6:05 AM America/New_York year-round (DST-safe via dual cron + gate)
    - cron: "5 10 * * *"  # 6:05 AM EDT
    - cron: "5 11 * * *"  # 6:05 AM EST
  workflow_dispatch:
    inputs:
      sport_preset:
        description: "Sports preset (Odds API sport keys)"
        type: choice
        options:
          - all
          - nfl
          - nba
          - mlb
          - nhl
          - ncaaf
          - ncaab
          - college
          - custom
        default: all
      sport_keys_custom:
        description: "Comma-separated Odds API sport keys (only when preset=custom)"
        required: false
        default: ""
      top_n:
        description: "Number of results to post"
        required: false
        default: "25"
      min_edge:
        description: "Minimum edge (probability points; 0.03 = 3pp)"
        required: false
        default: "0.03"
      debug_mode:
        description: "Debug: write extra artifacts and skip Discord"
        type: choice
        options: ["false", "true"]
        default: "false"
      debug_wide_scan:
        description: "DEBUG only: remove close-window bounds (can be very slow)"
        type: choice
        options: ["false", "true"]
        default: "false"

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install -q requests cryptography python-dateutil

      - name: Gate schedule to 6:05 AM America/New_York
        id: gate
        if: github.event_name == 'schedule'
        run: |
          python - <<'PY'
          from datetime import datetime
          from zoneinfo import ZoneInfo
          import os

          ny = ZoneInfo("America/New_York")
          now = datetime.now(tz=ny)
          should_run = (now.hour == 6 and 5 <= now.minute < 15)

          out = os.environ.get("GITHUB_OUTPUT")
          if out:
              with open(out, "a", encoding="utf-8") as f:
                  f.write(f"run={'true' if should_run else 'false'}\n")
          else:
              print("WARNING: GITHUB_OUTPUT not set; cannot emit step output.")

          print("NY time:", now.isoformat())
          print("Gate decision:", should_run)
          PY

      - name: Run Kalshi scan
        if: github.event_name != 'schedule' || steps.gate.outputs.run == 'true'
        env:
          THE_ODDS_API: ${{ secrets.THE_ODDS_API || secrets.ODDS_API_KEY }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_SPORTS_ALERT || secrets.DISCORD_WEBHOOK_URL }}

          # Kalshi auth (required for trade-api/v2)
          KALSHI_KEY_ID: ${{ secrets.KALSHI_API_KEY_ID || secrets.KALSHI_KEY_ID }}
          KALSHI_PRIVATE_KEY: ${{ secrets.KALSHI_PRIVATE_KEY }}
          # Official base host default; override via repo var if you ever need to.
          KALSHI_BASE: ${{ vars.KALSHI_BASE || 'https://api.elections.kalshi.com/trade-api/v2' }}

          SPORT_KEYS: ${{ github.event.inputs.sport_preset == 'nfl' && 'americanfootball_nfl' || github.event.inputs.sport_preset == 'nba' && 'basketball_nba' || github.event.inputs.sport_preset == 'mlb' && 'baseball_mlb' || github.event.inputs.sport_preset == 'nhl' && 'icehockey_nhl' || github.event.inputs.sport_preset == 'ncaaf' && 'americanfootball_ncaaf' || github.event.inputs.sport_preset == 'ncaab' && 'basketball_ncaab' || github.event.inputs.sport_preset == 'college' && 'americanfootball_ncaaf,basketball_ncaab' || github.event.inputs.sport_preset == 'custom' && github.event.inputs.sport_keys_custom || 'americanfootball_nfl,basketball_nba,baseball_mlb,icehockey_nhl,americanfootball_ncaaf,basketball_ncaab' }}

          TOP_N: ${{ github.event.inputs.top_n || '25' }}
          MIN_EDGE: ${{ github.event.inputs.min_edge || '0.03' }}
          DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
          KALSHI_DEBUG_WIDE_SCAN: ${{ github.event.inputs.debug_wide_scan || 'false' }}

          # One-time tuning knobs (set via repo Variables if you want; otherwise defaults apply)
          MIN_BOOKS: ${{ vars.KALSHI_MIN_BOOKS || '3' }}
          KALSHI_LOOKAHEAD_HOURS: ${{ vars.KALSHI_LOOKAHEAD_HOURS || '72' }}
          KALSHI_GAME_LOOKAHEAD_HOURS: ${{ vars.KALSHI_GAME_LOOKAHEAD_HOURS || '24' }}
          KALSHI_BUY_FEE_CENTS: ${{ vars.KALSHI_BUY_FEE_CENTS || '2' }}
          KALSHI_MIN_VOLUME: ${{ vars.KALSHI_MIN_VOLUME || '1000' }}
          KALSHI_USE_ORDERBOOK: ${{ vars.KALSHI_USE_ORDERBOOK || 'true' }}
          KALSHI_ORDERBOOK_MAX_CALLS: ${{ vars.KALSHI_ORDERBOOK_MAX_CALLS || '300' }}
          KALSHI_SERIES_MIN_SCORE: ${{ vars.KALSHI_SERIES_MIN_SCORE || '8' }}
          KALSHI_MAX_SERIES_TICKERS: ${{ vars.KALSHI_MAX_SERIES_TICKERS || '60' }}
          KALSHI_MVE_FILTER: ${{ vars.KALSHI_MVE_FILTER || 'all' }}
          KALSHI_SERIES_TICKERS: ${{ vars.KALSHI_SERIES_TICKERS || '' }}
          KALSHI_SERIES_CATEGORY: ${{ vars.KALSHI_SERIES_CATEGORY || 'Sports' }}
          KALSHI_SPORTS_SERIES_INCLUDE_REGEX: ${{ vars.KALSHI_SPORTS_SERIES_INCLUDE_REGEX || '(GAME|MONEYLINE|H2H|SPREAD|TOTAL|OVER|UNDER)' }}
          KALSHI_SPORTS_SERIES_EXCLUDE_REGEX: ${{ vars.KALSHI_SPORTS_SERIES_EXCLUDE_REGEX || '(PROP|PLAYER|MVP|CHAMP|TROPHY|AWARD|SEASON|FUTURE|FUTURES|WINS|EXACT|COMBO|PARLAY|PACK|SALE|COACH|TOP\\s*\\d|ALT|ALTERNATE|ATP|WTA|TENNIS|GOLF|MATCH\\s*BET)' }}
          KALSHI_MIN_CLOSE_BUFFER_HOURS: ${{ vars.KALSHI_MIN_CLOSE_BUFFER_HOURS || '0' }}

          # Ping Discord on manual runs even if 0 plays (so you know the job ran)
          ALWAYS_NOTIFY: ${{ github.event_name == 'workflow_dispatch' && 'true' || 'false' }}

          OUTDIR: out
        run: |
          python kalshi_sports_value.py

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kalshi-value-output
          path: out/
          if-no-files-found: warn
          retention-days: 14
