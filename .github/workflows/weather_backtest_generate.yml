name: Weather - Backtest Fair Prices

on:
  workflow_dispatch:
    inputs:
      city:
        description: "Optional city_key filter (blank = all)"
        required: false
        default: ""
      start_date:
        description: "Optional start date (YYYY-MM-DD)"
        required: false
        default: ""
      end_date:
        description: "Optional end date (YYYY-MM-DD)"
        required: false
        default: ""
      min_samples:
        description: "Minimum samples required to build the error model (per city+month)"
        required: false
        default: "25"
      laplace_alpha:
        description: "Laplace smoothing alpha (0.0 = none)"
        required: false
        default: "0.0"
      overwrite:
        description: "Overwrite existing artifacts"
        type: choice
        required: false
        default: "false"
        options: ["false", "true"]
      commit_results:
        description: "Commit outputs to repo (warning: can bloat repo)"
        type: choice
        required: false
        default: "false"
        options: ["false", "true"]

permissions:
  contents: write

concurrency:
  group: weather-backtest-generate
  cancel-in-progress: false

jobs:
  backtest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r weather/requirements.txt

      - name: Generate backtest fair price artifacts
        env:
          WEATHER_SNAPSHOT_HOUR_LOCAL: "5"
        run: |
          ARGS=()
          if [[ -n "${{ github.event.inputs.city }}" ]]; then
            ARGS+=(--city "${{ github.event.inputs.city }}")
          fi
          if [[ -n "${{ github.event.inputs.start_date }}" ]]; then
            ARGS+=(--start-date "${{ github.event.inputs.start_date }}")
          fi
          if [[ -n "${{ github.event.inputs.end_date }}" ]]; then
            ARGS+=(--end-date "${{ github.event.inputs.end_date }}")
          fi
          ARGS+=(--min-samples "${{ github.event.inputs.min_samples }}")
          ARGS+=(--laplace-alpha "${{ github.event.inputs.laplace_alpha }}")
          if [[ "${{ github.event.inputs.overwrite }}" == "true" ]]; then
            ARGS+=(--overwrite)
          fi
          python -m weather.scripts.backtest_generate_fair_prices "${ARGS[@]}"

      - name: Upload backtest artifacts
        uses: actions/upload-artifact@v4
        with:
          name: weather-backtest-fair-prices
          path: weather/outputs/backtest_fair_prices

      - name: Commit changes (optional)
        if: github.event.inputs.commit_results == 'true'
        run: |
          set -e
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add weather/outputs/backtest_fair_prices
            git commit -m "weather: backtest fair price artifacts"
            git push
          else
            echo "No changes to commit."
          fi
