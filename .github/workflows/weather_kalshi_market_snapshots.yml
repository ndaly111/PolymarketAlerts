name: Weather - Kalshi Market Snapshots

on:
  schedule:
    # Daily snapshot around the other weather jobs.
    - cron: "20 16 * * *"
  workflow_dispatch:
    inputs:
      series_tickers:
        description: "Comma-separated Kalshi series tickers (defaults to repo var WEATHER_KALSHI_SERIES_TICKERS)"
        required: false
        default: ""
      require_city_match:
        description: "Only store markets that match a known city_key"
        required: false
        default: "true"

permissions:
  contents: write

concurrency:
  group: weather-kalshi-market-snapshots
  cancel-in-progress: false

jobs:
  snapshot:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r weather/requirements.txt
          pip install -r requirements.txt

      - name: Snapshot Kalshi weather markets
        env:
          # Kalshi auth (same as other workflows/scripts)
          KALSHI_KEY_ID: ${{ secrets.KALSHI_KEY_ID || secrets.KALSHI_API_KEY_ID }}
          KALSHI_API_KEY_ID: ${{ secrets.KALSHI_API_KEY_ID }}
          KALSHI_PRIVATE_KEY: ${{ secrets.KALSHI_PRIVATE_KEY }}
          KALSHI_BASE: ${{ vars.KALSHI_BASE || 'https://api.elections.kalshi.com/trade-api/v2' }}

          # Which series to pull
          WEATHER_KALSHI_SERIES_TICKERS: >-
            ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.series_tickers != ''
              && github.event.inputs.series_tickers
              || vars.WEATHER_KALSHI_SERIES_TICKERS || '' }}
        run: |
          if [[ -z "${WEATHER_KALSHI_SERIES_TICKERS}" ]]; then
            echo "WEATHER_KALSHI_SERIES_TICKERS is empty; skipping snapshot."
            exit 0
          fi
          ARGS=()
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ github.event.inputs.require_city_match }}" == "true" ]]; then
              ARGS+=(--require-city-match)
            fi
          else
            # Safer default on schedule
            ARGS+=(--require-city-match)
          fi
          python -m weather.scripts.collect_kalshi_weather_markets "${ARGS[@]}"

      - name: Commit changes (if any)
        run: |
          set -e
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add weather/data/weather.db
            git commit -m "weather: snapshot Kalshi market quotes"
            git push
          else
            echo "No changes to commit."
          fi
