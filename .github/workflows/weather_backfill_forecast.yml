name: Weather - Backfill Forecast Snapshots (Open-Meteo Historical Forecast)

on:
  workflow_dispatch:
    inputs:
      city:
        description: "Optional city_key filter (blank = all)"
        required: false
        default: ""
      start_date:
        description: "Start date (YYYY-MM-DD)"
        required: true
      end_date:
        description: "End date (YYYY-MM-DD)"
        required: true
      snapshot_hour_local:
        description: "Snapshot hour local to label rows (e.g., 5)"
        required: false
        default: "5"
      max_days_per_call:
        description: "Max days per Open-Meteo request chunk (larger = fewer calls)"
        required: false
        default: "31"
      sleep:
        description: "Sleep between Open-Meteo calls (seconds)"
        required: false
        default: "0.25"
      commit_results:
        description: "Commit updated weather_forecast_accuracy.db to repo"
        type: choice
        required: false
        default: "false"
        options: ["false", "true"]

permissions:
  contents: write

concurrency:
  # Backfills can take a while; keep them isolated so they don't block Daily Scan.
  group: weather-backfill-forecast
  cancel-in-progress: false

jobs:
  backfill:
    runs-on: ubuntu-latest
    env:
      WEATHER_DB_PATH: weather/data/weather_forecast_accuracy.db
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Weather setup
        uses: ./.github/actions/weather_setup
        with:
          python-version: "3.11"
          install-root-requirements: "true"

      - name: Backfill forecast snapshots (Open-Meteo historical forecast)
        run: |
          ARGS=()
          if [[ -n "${{ github.event.inputs.city }}" ]]; then
            ARGS+=(--city "${{ github.event.inputs.city }}")
          fi
          ARGS+=(--start-date "${{ github.event.inputs.start_date }}")
          ARGS+=(--end-date "${{ github.event.inputs.end_date }}")
          ARGS+=(--snapshot-hour-local "${{ github.event.inputs.snapshot_hour_local }}")
          ARGS+=(--max-days-per-call "${{ github.event.inputs.max_days_per_call }}")
          ARGS+=(--sleep "${{ github.event.inputs.sleep }}")
          ARGS+=(--db "$WEATHER_DB_PATH")
          python -m weather.scripts.backfill_forecast_open_meteo "${ARGS[@]}"

      - name: Upload updated DB
        uses: actions/upload-artifact@v4
        with:
          name: weather-db-after-forecast-backfill
          path: ${{ env.WEATHER_DB_PATH }}

      - name: Commit changes (optional)
        if: github.event.inputs.commit_results == 'true'
        run: |
          set -e
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add "$WEATHER_DB_PATH"
            git commit -m "weather: backfill forecast snapshots (open-meteo historical forecast)"
            ok=0
            for i in 1 2 3; do
              git pull --rebase && git push && ok=1 && break
              echo "Push failed (attempt $i). Retrying..."
              sleep 2
            done
            if [[ "$ok" != "1" ]]; then
              echo "ERROR: Could not push after 3 attempts."
              exit 1
            fi
          else
            echo "No changes to commit."
          fi
