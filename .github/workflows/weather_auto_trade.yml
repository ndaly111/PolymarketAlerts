name: Weather Auto Trade

on:
  schedule:
    # Run every 15 min from 4am to 8pm ET (no API costs - NWS and Kalshi are free)
    - cron: "*/15 9-23 * * *"   # 4am-6:45pm ET (9-23 UTC)
    - cron: "*/15 0 * * *"      # 7pm-7:45pm ET (0 UTC)
    - cron: "0 1 * * *"         # 8pm ET final run (1 UTC)
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run mode (no real trades)"
        required: false
        default: "false"
        type: boolean

permissions:
  contents: write

concurrency:
  group: weather-auto-trade
  cancel-in-progress: false

jobs:
  trade:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      TZ: America/New_York
      PYTHONPATH: ${{ github.workspace }}
      # Kalshi API credentials
      KALSHI_API_KEY_ID: ${{ secrets.KALSHI_API_KEY_ID }}
      KALSHI_PRIVATE_KEY: ${{ secrets.KALSHI_PRIVATE_KEY }}
      KALSHI_BASE: ${{ vars.KALSHI_BASE || 'https://api.elections.kalshi.com/trade-api/v2' }}
      # NWS API
      NWS_USER_AGENT: "weather-auto-trader/0.1 (contact: ${{ secrets.NWS_CONTACT_EMAIL || 'you@example.com' }})"
      # Weather database
      WEATHER_DB_PATH: weather/data/weather_forecast_accuracy.db
      # Trades database
      WEATHER_TRADES_DB_PATH: weather_trades.db
      # Trading parameters
      WEATHER_MIN_EV: "0.10"
      WEATHER_AUTOTRADE_MIN_EV: ${{ vars.WEATHER_AUTOTRADE_MIN_EV || '0.10' }}
      WEATHER_MIN_Q: "0.05"
      WEATHER_MAX_ASK: "85"
      WEATHER_MAX_TRADES_PER_DAY: "10"
      WEATHER_ORDER_TIMEOUT: "30"
      WEATHER_CONTRACTS_PER_TRADE: "1"
      WEATHER_AUTOTRADE_ENABLED: ${{ vars.WEATHER_AUTOTRADE_ENABLED || '0' }}
      # Forecast/model config
      WEATHER_FORECAST_SOURCE: nws_hourly_max
      WEATHER_ERROR_MODEL_SOURCE: mos_gfs_18z_archive
      WEATHER_ERROR_MODEL_HOUR: "12"
      WEATHER_ENABLE_INTRADAY_ADJUSTMENT: "true"
      # Discord notifications
      DISCORD_WEATHER_TRADES_WEBHOOK: ${{ secrets.DISCORD_WEATHER_ALERTS || secrets.DISCORD_WEBHOOK_URL }}
      # Dry run (off by default for live trading)
      WEATHER_DRY_RUN: ${{ github.event.inputs.dry_run == 'true' && '1' || '0' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install requests cryptography pyyaml

      - name: Check credentials
        run: |
          if [ -z "$KALSHI_API_KEY_ID" ] || [ -z "$KALSHI_PRIVATE_KEY" ]; then
            echo "ERROR: Kalshi credentials not configured"
            echo "Please set KALSHI_API_KEY_ID and KALSHI_PRIVATE_KEY secrets"
            exit 1
          fi
          echo "Credentials OK"

      - name: Ensure directories exist
        run: |
          mkdir -p weather/outputs/fair_prices
          mkdir -p weather/outputs/edges
          mkdir -p weather/outputs/models
          mkdir -p weather/data

      - name: Run auto trader
        run: |
          echo "Running weather auto trader..."
          echo "Dry run: $WEATHER_DRY_RUN"
          python weather_auto_trade.py

      - name: Upload trades DB
        uses: actions/upload-artifact@v4
        with:
          name: weather-trades-db-${{ github.run_id }}
          path: ${{ env.WEATHER_TRADES_DB_PATH }}
          retention-days: 30
          if-no-files-found: ignore

      - name: Commit DB changes
        if: success()
        run: |
          if [ -f "$WEATHER_TRADES_DB_PATH" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add "$WEATHER_TRADES_DB_PATH" || true
            git add "weather/data/weather_forecast_accuracy.db" || true
            if git diff --staged --quiet; then
              echo "No DB changes to commit"
            else
              git commit -m "weather: update trades database"
              for i in 1 2 3; do
                git pull --rebase && git push && break
                echo "Push attempt $i failed, retrying..."
                sleep 2
              done
            fi
          fi
