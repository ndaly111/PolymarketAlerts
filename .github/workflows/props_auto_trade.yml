name: Props Auto Trade

on:
  schedule:
    # Run every 15 min from 5am to 8pm EST (10:00-01:00 UTC)
    - cron: "*/15 10-23 * * *"  # 5am-6:45pm EST
    - cron: "*/15 0 * * *"      # 7pm-7:45pm EST
    - cron: "0 1 * * *"         # 8pm EST (last run)
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run mode (no real trades)"
        required: false
        default: "true"
        type: boolean

permissions:
  contents: write

concurrency:
  group: props-auto-trade
  cancel-in-progress: false

jobs:
  trade:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      PYTHONPATH: ${{ github.workspace }}
      # Kalshi API credentials
      KALSHI_API_KEY_ID: ${{ secrets.KALSHI_API_KEY_ID }}
      KALSHI_PRIVATE_KEY: ${{ secrets.KALSHI_PRIVATE_KEY }}
      KALSHI_BASE: ${{ vars.KALSHI_BASE || 'https://api.elections.kalshi.com/trade-api/v2' }}
      # Odds API
      THE_ODDS_API: ${{ secrets.THE_ODDS_API }}
      # Trading parameters
      MIN_INITIAL_EV: "0.10"
      MIN_FINAL_EV: "0.05"
      MIN_BOOKS: "3"
      MAX_KALSHI_ASK: "67"
      MIN_FAIR_PROB: "0.333"
      MAX_TRADES_PER_DAY: "10"
      ORDER_TIMEOUT: "30"
      CONTRACTS_PER_TRADE: "1"
      # Database
      PROPS_DB_PATH: props_trades.db
      # Discord notifications
      DISCORD_PROPS_WEBHOOK: ${{ secrets.DISCORD_PROPS_WEBHOOK || secrets.DISCORD_WEBHOOK_URL }}
      # Dry run (default true for safety)
      DRY_RUN: ${{ github.event.inputs.dry_run == 'true' && '1' || '0' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install requests cryptography

      - name: Check credentials
        run: |
          if [ -z "$KALSHI_API_KEY_ID" ] || [ -z "$KALSHI_PRIVATE_KEY" ]; then
            echo "ERROR: Kalshi credentials not configured"
            echo "Please set KALSHI_API_KEY_ID and KALSHI_PRIVATE_KEY secrets"
            exit 1
          fi
          if [ -z "$THE_ODDS_API" ]; then
            echo "ERROR: THE_ODDS_API key not configured"
            exit 1
          fi
          echo "Credentials OK"

      - name: Download trades DB (if exists)
        continue-on-error: true
        run: |
          # Try to get the latest DB from artifacts
          # This ensures continuity of daily trade limits
          echo "Looking for existing trades database..."
          if [ -f "$PROPS_DB_PATH" ]; then
            echo "Database exists locally"
          else
            echo "No existing database, will create new one"
          fi

      - name: Run auto trader
        run: |
          echo "Running props auto trader..."
          echo "Dry run: $DRY_RUN"
          python props_auto_trade.py

      - name: Upload trades DB
        uses: actions/upload-artifact@v4
        with:
          name: props-trades-db-${{ github.run_id }}
          path: ${{ env.PROPS_DB_PATH }}
          retention-days: 30
          if-no-files-found: ignore

      - name: Commit DB changes
        if: success()
        run: |
          if [ -f "$PROPS_DB_PATH" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add "$PROPS_DB_PATH" || true
            if git diff --staged --quiet; then
              echo "No DB changes to commit"
            else
              git commit -m "props: update trades database"
              for i in 1 2 3; do
                git pull --rebase && git push && break
                echo "Push attempt $i failed, retrying..."
                sleep 2
              done
            fi
          fi
