name: Weather - Collect 4AM Baseline Snapshots

on:
  workflow_dispatch:
    inputs:
      overwrite:
        description: "Overwrite existing snapshots for today"
        required: false
        default: "false"
        type: boolean
  schedule:
    # Run at 9:05 UTC (4:05 AM ET) to collect hour=4 baseline snapshots
    # This is the reference point for intraday progress calculations
    - cron: "5 9 * * *"

permissions:
  contents: write

concurrency:
  group: weather-collect-snapshots
  cancel-in-progress: false

jobs:
  snapshots:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      PYTHONPATH: ${{ github.workspace }}
      FORECAST_SOURCE: nws_hourly_max
      WEATHER_DB_PATH: weather/data/weather_forecast_accuracy.db
      # Fixed hour=4 for all cities (baseline for intraday progress)
      WEATHER_SNAPSHOT_HOUR_LOCAL: "4"
      NWS_USER_AGENT: "weather-edge-bot/0.1 (contact: ${{ secrets.NWS_CONTACT_EMAIL || 'you@example.com' }})"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Weather setup
        uses: ./.github/actions/weather_setup
        with:
          python-version: "3.11"
          install-root-requirements: "true"

      - name: Collect 4AM baseline snapshots
        shell: bash
        run: |
          set -e
          # Do NOT use --use-local-hour; we want hour=4 for all cities
          ARGS="--no-gate --skip-if-date-exists"
          if [[ "${{ github.event.inputs.overwrite }}" == "true" ]]; then
            ARGS="--no-gate --overwrite"
          fi
          echo "Collecting hour=4 baseline snapshots..."
          echo "Running: python -m weather.scripts.collect_forecast_snapshot --db $WEATHER_DB_PATH $ARGS"
          python -m weather.scripts.collect_forecast_snapshot --db "$WEATHER_DB_PATH" $ARGS

      - name: Commit DB (if changed)
        shell: bash
        run: |
          set -e
          if [[ -n "$(git status --porcelain "$WEATHER_DB_PATH")" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add "$WEATHER_DB_PATH"
            git commit -m "weather: collect forecast snapshots"
            for i in 1 2 3; do
              git pull --rebase && git push && break
              echo "Push attempt $i failed, retrying..."
              sleep 2
            done
          else
            echo "No DB changes to commit."
          fi
