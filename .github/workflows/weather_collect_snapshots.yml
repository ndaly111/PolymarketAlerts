name: Weather - Collect Forecast Snapshots (Canonical 04:00 Local)

on:
  schedule:
    # Cron is UTC. Run in a window that safely covers 04:00 local
    # for ET/CT/MT/PT across DST changes.
    # (ET 04:00 is 08–09 UTC; PT 04:00 is 11–12 UTC)
    - cron: "*/30 7-15 * * *"
  workflow_dispatch:
    inputs:
      snapshot_hour_local:
        description: "Local hour for canonical snapshot (default 4)"
        required: false
        default: "4"
      late_window_hours:
        description: "Allow late starts to still write intended snapshot hour"
        required: false
        default: "3"
      no_gate:
        description: "If true, bypass local-time gate (debug only; NOT canonical)"
        required: false
        default: "false"

permissions:
  contents: write

concurrency:
  # Snapshot workflow is scheduled every 30 minutes.
  # If a run is slow, overlapping runs can fight over commits/pushes.
  # Prefer the newest run and cancel older ones.
  group: weather-collect-snapshots
  cancel-in-progress: true

jobs:
  snapshots:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
      FORECAST_SOURCE: nws_hourly_max
      # Canonical snapshot hour (local per city)
      WEATHER_SNAPSHOT_HOUR_LOCAL: ${{ (github.event.inputs.snapshot_hour_local != '' && github.event.inputs.snapshot_hour_local) || '4' }}
      WEATHER_SNAPSHOT_MINUTE_MAX: "59"
      WEATHER_SNAPSHOT_LATE_WINDOW_HOURS: ${{ (github.event.inputs.late_window_hours != '' && github.event.inputs.late_window_hours) || '3' }}
      NWS_USER_AGENT: "weather-edge-bot/0.1 (contact: ${{ secrets.NWS_CONTACT_EMAIL || 'you@example.com' }})"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Weather setup
        uses: ./.github/actions/weather_setup
        with:
          python-version: "3.11"
          install-root-requirements: "true"

      - name: Collect canonical snapshots
        shell: bash
        run: |
          set -e
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.no_gate }}" == "true" ]]; then
            echo "[snapshots] running with --no-gate (debug only; NOT canonical)"
            python -m weather.scripts.collect_forecast_snapshot --no-gate
          else
            python -m weather.scripts.collect_forecast_snapshot
          fi

      - name: Snapshot coverage summary (non-blocking)
        continue-on-error: true
        shell: bash
        run: |
          # Use ET date so the receipt matches how we reason about "today" operationally.
          export TZ=America/New_York
          python weather/scripts/check_forecast_snapshot_freshness.py \
            --forecast-source "$FORECAST_SOURCE" \
            --snapshot-hour "$WEATHER_SNAPSHOT_HOUR_LOCAL" \
            --target-date "$(date +%F)" \
            --min-pct 0.0 \
            --min-count 0

      - name: Commit DB (if changed)
        shell: bash
        run: |
          set -e
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add weather/data/weather.db
            git commit -m "weather: collect canonical forecast snapshots"
            ok=0
            for i in 1 2 3; do
              git pull --rebase && git push && ok=1 && break
              echo "Push failed (attempt $i). Retrying..."
              sleep 2
            done
            if [[ "$ok" != "1" ]]; then
              echo "WARN: Could not push snapshots after 3 attempts."
              exit 1
            fi
          else
            echo "No DB changes to commit."
          fi
