name: Weather - Simulation Test (Offline Fixtures)

on:
  workflow_dispatch:
    inputs:
      city:
        description: "City key or label (e.g., chicago)"
        required: true
        default: "chicago"
      target_date:
        description: "YYYY-MM-DD"
        required: true
        default: "2026-01-24"
      forecast_high:
        description: "Fake forecast high in °F"
        required: true
        default: "8"
      forecast_source:
        description: "Label for forecast_snapshots.source"
        required: false
        default: "nws_hourly_max"
      snapshot_hour_local:
        description: "Snapshot hour local (aligns with error model)"
        required: false
        default: "6"
      markets_json:
        description: "Path to fixtures JSON (optional)"
        required: false
        default: "weather/fixtures/kalshi_weather_fixture_chicago_realistic.json"

permissions:
  contents: read

concurrency:
  group: weather-simulation-test
  cancel-in-progress: true

jobs:
  simulate:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
      WEATHER_OFFLINE_FIXTURES: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Weather setup
        uses: ./.github/actions/weather_setup
        with:
          python-version: "3.11"
          install-root-requirements: "true"

      - name: Run offline simulation
        run: |
          set -euo pipefail
          python -m weather.scripts.simulate_daily_scan \
            --db weather/data/weather_sim.db \
            --city "${{ github.event.inputs.city }}" \
            --target-date "${{ github.event.inputs.target_date }}" \
            --forecast-high "${{ github.event.inputs.forecast_high }}" \
            --forecast-source "${{ github.event.inputs.forecast_source }}" \
            --snapshot-hour-local "${{ github.event.inputs.snapshot_hour_local }}" \
            --markets-json "${{ github.event.inputs.markets_json }}"

      - name: Post simulation result to Discord (manual runs always post)
        if: always()
        env:
          WEATHER_DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEATHER_ALERTS }}
        run: |
          set -euo pipefail

          if [ -z "${WEATHER_DISCORD_WEBHOOK:-}" ]; then
            echo "WEATHER_DISCORD_WEBHOOK secret not set; skipping Discord post."
            exit 0
          fi

          echo "Discord webhook present (length=${#WEATHER_DISCORD_WEBHOOK})."

          SRC_SANITIZED="$(echo "${{ github.event.inputs.forecast_source }}" | tr '/' '_' )"
          TARGET_DATE="${{ github.event.inputs.target_date }}"
          SUMMARY_PATH="weather/outputs/edges/${SRC_SANITIZED}/${TARGET_DATE}/SUMMARY.md"

          RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          HEADER="**Weather Simulation (Offline Fixtures)**  \nCity: \`${{ github.event.inputs.city }}\`  \nDate: \`${TARGET_DATE}\`  \nSource: \`${{ github.event.inputs.forecast_source }}\`  \nRun: ${RUN_URL}\n"

          if [ -f "${SUMMARY_PATH}" ]; then
            export SUMMARY_PATH
            BODY="$(python - <<'PY'
from pathlib import Path
import os

summary_path = Path(os.environ["SUMMARY_PATH"])
summary_text = summary_path.read_text(encoding="utf-8")
print(summary_text[:1800])
PY
)"
            CONTENT="${HEADER}\n\`\`\`\n${BODY}\n\`\`\`"
          else
            CONTENT="${HEADER}\n⚠️ SUMMARY.md not found at \`${SUMMARY_PATH}\`.\nCheck artifacts for outputs + DB."
          fi

          export DISCORD_CONTENT="${CONTENT}"
          python - <<'PY'
import json
import os
urllib.request.urlopen(request).read()
print("Posted to Discord.")
PY

      - name: Upload simulation outputs
        uses: actions/upload-artifact@v4
        with:
          name: weather-sim-outputs
          path: |
            weather/outputs/**
            weather/data/weather_sim.db
